<div class="eqLogic eqLogic-widget allowResize allowReorderCmd #class#" data-eqType="#eqType#" data-eqLogic_id="#id#" data-eqLogic_uid="#uid#" data-version="#version#" data-translate-category="#translate_category#" data-category="#category#" data-tags="#tags#" style="width:#width#;height:#height#;#style#">
  <style>
    :root {
      --shadow-#uid# : 2px 2px 3px var(--link-color);
      --solar_colour#uid# : orange;
      --solar_colour-0-#uid# : var(--solar_colour#uid#);
      --battery_colour#uid# : pink;
      --battery-state#uid# : var(--battery_colour#uid#);
      --battery-state-0-#uid# : red;
      --battery-state-25-#uid# : OrangeRed;
      --battery-state-50-#uid# : Orange;
      --battery-state-75-#uid# : #9ACD32;
      --battery-state-100-#uid# : Green;
      --battery-charge#uid# : var(--battery_colour#uid#);
      --battery-discharge#uid# : var(--battery_colour#uid#);
      --battery_mppt_colour#uid# : #ffa500;
      --aux_colour#uid# : #a43df5;
      --grid_colour#uid# : #5490c2;
      --grid-sell-colour#uid# : var(--grid_colour#uid#);
      --grid-buy-colour#uid# : var(--grid_colour#uid#);
      --load_colour#uid# : #5fb6ad;
      --inverter_colour#uid# : grey;
      --inverter_secondary_colour#uid# : black;
      --inverterStateColour#uid#: transparent;
      --background#uid#: transparent;
      --no_grid_colour#uid#: #db041c;
      --color_alerte#uid#: #ff0000;
      --strokeGaugeRatio-#uid#: 5;
      --label-tempo-red#uid#: #E85130;
      --label-tempo-blue#uid#: #1057c8;
      --label-tempo-white#uid#: #F4F4F4;
      --label-tempo-undefined#uid#: transparent;
    }
    .widget#uid#{width: 100%;}
    .container#uid# {
      justify-content: center;
      height: 100%;
      width: 100%;
    }
    #div_error#uid# {
      padding: 10px 10px 10px 10px;
      margin-bottom: 10px;
      border: 3px var(--al-danger-color) solid;
      width: 90%;
      font-size: 16px;
      line-height: 24px;
    }
    .card#uid# {background: var(--background#uid#, transparent);}
    .left-align#uid# {text-anchor: start;}
    .right-align#uid# {text-anchor: end;}
    .center-align#uid# {text-anchor: middle;}
    .ft7-#uid#{font-size:7px;}
    .ft8-#uid#{font-size:8px;}
    .ft9-#uid#{font-size:9px;}
    .ft10-#uid#{font-size:10px;}
    .ft11-#uid#{font-size:11px;}
    .ft12-#uid#{font-size:12px;}
    .ft13-#uid#{font-size:13px;}
    .ft14-#uid#{font-size:14px;}
    .ft15-#uid#{font-size:15px;}
    .ft16-#uid#{font-size:16px;}
    .ft18-#uid#{font-size:18px;}
    .ft22-#uid#{font-size:22px;}
    .ftw-#uid#{font-weight:500}
    .hidden-#uid#{display:none;}
    
    @keyframes blinking#uid# {
      0% { opacity: 0.8; }
      100% { opacity: 0.4; }
    }
    .blink#uid# {
      -moz-animation: blinking#uid# 0.7s linear infinite;
      -webkit-animation: blinking#uid# 0.7s linear infinite;
      animation: blinking#uid# 0.7s linear infinite;
    }
    .op-#uid# {
      opacity: 0.4;
    }
    .widget#uid#.shadow#uid# .sh-#uid# { 
      text-shadow: var(--shadow-#uid#);
    }
    .no_grid#uid# {
      color: var(--no_grid_colour#uid#) !important;
    }
    .circle#uid# {
      animation: rotate-in7126 0.6s ease-in;
      transition: stroke-dashoffset 0.4s, stroke-dasharray 0.4s;
      stroke-width: var(--strokeGaugeRatio-#uid#);
    }
  </style>
  <center class="widget-name">
    <span class="warning" title="#alert_name#">
      <i class='#alert_icon#'></i>
    </span>
    <span class="cmd refresh pull-right cursor" data-cmd_id="#refresh_id#">
      <i class="fas fa-sync"></i>
    </span>
    <span class="reportModeVisible">#name_display# <span class="object_name">#object_name#</span></span>
    <a href="#eqLink#" class="reportModeHidden">#name_display# <span class="object_name">#object_name#</span></a>
  </center>

  <div class="cmds #isVerticalAlign#">
    <div class="cmd cmd-widget" style="width: 100%;">
    <div class="hidden-#uid#" id="div_error#uid#"></div>
    <div class="widget#uid#" id="widget#uid#"></div>
  
    <script>
      ////////////////////////////////////////////////////////
      ////////////////////// VARIABLES ///////////////////////
      ////////////////////////////////////////////////////////
      var debug#uid# = ('#debug#' == 1) ? true : false
      var versionWidget#uid# = '#version_widget#'
      //var float = false
      var timer_in#uid# = false
      var unite_conversion#uid# = { 'W' : [1000, 'W', 'kW', 'MW'], 'Wh' : [1000, 'Wh', 'kWh', 'MWh'], 'l' : [1000, 'l', 'm<sup>3</sup>'] }
      var JsonTempoArray#uid# = []
      var timer#uid# = false
      var labelsList = [
        { key: 'RED', data: { txt: 'Rouge', label: 'label-tempo-red#uid#' }},
        { key: 'BLUE', data: { txt: 'Bleu', label: 'label-tempo-blue#uid#' }},
        { key: 'WHITE', data: { txt: 'Blanc', label: 'label-tempo-white#uid#' }},
        { key: 'UNDEFINED', data: { txt: 'undefined', label: 'label-tempo-undefined#uid#' }}
      ];
    
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] Compatibilité V4.3 V4.4 [' + versionWidget#uid# + '] ───────────────')
    
      ////////////////////////////////////////////////////////
      ////////////////////// FUNCTION ////////////////////////
      ////////////////////////////////////////////////////////
      function log#uid#(text) {
        if (debug#uid#) console.log(text)
      }
      function getLabel(key){
        return labelsList.find(item => item.key.toLowerCase() === key.toLowerCase())?labelsList.find(item => item.key.toLowerCase() === key.toLowerCase()).data.label:'label-error#uid#';
      }
      /*
      function trunc#uid#(value = 0, trunc = 1, forceDec = false) {
        trunc = (trunc == 0) ? 1 : (trunc == 1) ? 10 : (trunc == 2) ? 100 : (trunc == 3) ? 1000 : 10
        var result = 0
        if (value === null || value == '' || (isNaN(value) == true)) value = 0
        result = Math.trunc(value * trunc) / trunc
        result = (forceDec && forceDec >= 1 && Number.isInteger(result)) ? result.toFixed(forceDec) : result
        return result;
      }
      */
      function trunc#uid#(value = 0, trunc = 1, forceDec = false) {
        trunc = Math.min(trunc, 3)
        var result = 0
        if (value === null || value == '' || (isNaN(value) == true)) value = 0
        let dec = value.toString().includes('.') ? (value.toString().length - 1) - value.toString().indexOf('.') : 0
        if (trunc == 0) {
          result = value.toString().includes('.') ? value.toString().substring(0, value.toString().indexOf('.')) : value
        }
        else if (dec > trunc) {
          result = value.toString().substring(0, value.toString().indexOf('.') + 1 + trunc)
        } else {
          result = value
        }
        result = (forceDec && forceDec >= 1 && Number.isInteger(result)) ? result.toFixed(forceDec) : result
        return result;
      }
      function autoValueArray#uid#(value, unit = '', trunc = 1) {
        var result = { }
        result.unit = unit.replace("\"", "").replace("\'", "")
        if (value === null || value == '') {
          result.value = 0
          return result;
        }
        if(isNaN(value) == true){
          result.value = value
          return result;
        }
        if (isset(unite_conversion#uid#[unit])) {
          let mod = unite_conversion#uid#[unit][0]
          let prefix = unite_conversion#uid#[unit].slice(1)
          let myval = autoValueFormat#uid#(value, mod, prefix.length - 1)
          result.value = myval[0]
          result.unit = prefix[myval[1]]
        } else result.value = value //Math.trunc(value * trunc) / trunc
        return result;
      }
      function autoValueFormat#uid#(value, mod = 1000, maxdiv = 10) {
        let val = 0
        if (value < 0) val = parseFloat(-value)
        else val = parseFloat(value)
        for (div = 0; div < maxdiv && val >= mod; div++) {
          val = parseFloat(val / mod)
        }
        if (value < 0) val = -val
        return Array(val, div);
      }
    function getBatteryIcon#uid#(value=false, full_capacity=80, empty_capacity=30, icon_perso=false) {
      log#uid#('| getBatteryIcon() -> ' + value + ' | ' + full_capacity + ' | ' + empty_capacity + ' | ' + icon_perso)
      let available = full_capacity - empty_capacity
      let value_pourcent = Math.trunc(value * available / 100)
      if (value_pourcent <= 0) return '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-battery-0"/>';
      else if (value_pourcent < 50) return '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-battery-25"/>';
      else if (value_pourcent < 75) return '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-battery-50"/>';
      else if (value_pourcent < 100) return '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-battery-75"/>';
      else return '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-battery-100"/>';
    }
    
    function numIsPair(n) {
      return (n & 1) ? false : true;
    }
    
    function formatMillier(nombre, active=false){
      if (!active) return nombre;
      //return Intl.NumberFormat().format(nombre);
      nombre += '';
      var sep = ' ';
      var reg = /(\d+)(\d{3})/;
      while( reg.test( nombre)) {
        nombre = nombre.replace( reg, '$1' +sep +'$2');
      }
      return nombre;
    }
    ////////////////////////////////////////////////////////
    //////////////////////// CONFIG ////////////////////////
    ////////////////////////////////////////////////////////
    var config#uid# = {
      has_battery: false,
      has_load: false,
      has_aux: false,
      has_grid: false,
      has_solar: false,
      blink: false,
      font_alert: false,
      activateGauge: true,
      activateGaugeRatio: true,
      formatMillier: false,
      autoConversionUnit: true,
      powerTrunc: 2,
      inverter: {
        autarky: 'no', // no, energy, power
        autarky_state: 10, // affiché si autarky = energy
        autarkyp_state: 20, // affiché si autarky = power
        ratio_state: 30, // affiché si autarky = energy
        ratiop_state: 40, // affiché si autarky = power
        autarky_text: 'Autarky', // affiché si autarky != no
        ratio_text:'Ratio', // affiché si autarky != no
        model: 'defaut', //'sunsynk',
        voltage_state: false,
        voltage_unit: 'V',
        voltage_isHistorized:0,
        voltage_id: false,
        frequency_state: false,
        frequency_unit: 'Hz',
        frequency_isHistorized:0,
        frequency_id: false,
        current_state: false,
        current_unit: 'A',
        current_isHistorized:0,
        current_id: false,
        lcd_state: false,
        lcd_unit: '',
        lcd_isHistorized:0,
        lcd_id: false,
        temp:{
          ac_state: false,
          ac_unit: '°C',
          ac_isHistorized:0,
          ac_id: false,
          dc_state: false,
          dc_unit: '°C',
          dc_isHistorized:0,
          dc_id: false,
        },
      },
      battery: {
        animation_speed: 5,
        energy: false,
        max_power: false,
        alert_power: false,
        capacity: false,
        autoColorBattery: true,
        power_invert: false,
        voltage: {
          show: false,
          state: 0,
          unit: 'V',
          isHistorized:0,
          id: false,
        },
        current: {
          show: false,
          state: 0,
          unit: 'A',
          isHistorized:0,
          id: false,
        },
        temp: {
          show: false,
          state: 0,
          unit: '°',
          isHistorized:0,
          id: false,
        },
        power: {
          isHistorized:0,
          id: false,
          show: false,
          state: 0,
          unit: 'W'
        },
        state: {
          show: false,
          state: 100,
          unit: '%',
          isHistorized:0,
          id: false,
        },
        daily: {
          show_charge: false,
          show_discharge: false,
          charge_state: 0,
          discharge_state: 0,
          charge_unit: '',
          discharge_unit: '',
          charge_isHistorized: 0,
          charge_id: false,
          discharge_isHistorized: 0,
          discharge_id: false,
          text_charge: 'CHARGE JOUR',
          text_discharge: 'DECHARGE JOUR',
        },
        mppt : {
          has_mppt_power: false,
          isHistorized:0,
          id: false,
          max_power: false,
          alert_power: false,
          power: {
            show: false,
            state: 0,
            unit: 'W',
            isHistorized:0,
            id: false,
          },
          energy: {
            show: false,
            state: 0,
            unit: 'Wh',
            isHistorized:0,
            id: false,
          },
          name: '',
          voltage: false,
          voltage_unit: 'A',
          current: false,
          current_unit: 0
        },
        full_capacity: 100, // Todo -> param optionnel
        empty_capacity: 0, // Todo -> param optionnel
        soc: {
          shutdown: 0
        },
        icon: false,
      },
      solars: {},
      solar: {
        animation_speed: 5,
        max_power: false,
        alert_power: false,
        power: 0,
        power_unit: '',
        has_pv_power: false,
        animate_solar_enable: true, // TODO
        mppts: 0,
        isHistorized:0,
        id: false,
        daily: {
          show: false,
          state: 0,
          unit: '',
          text: 'PROD JOUR',
          isHistorized:0,
          id: false,
        },
        sell: false, // on, off, 1, 0, undefined // Todo        
      },
      load: {
        animation_speed: 5,
        max_power: false,
        alert_power: false,
        power: 0,
        power_unit: '',
        has_load_power: false,
        animate_load_enable: true,
        additional_loads: 0,
        force4load: false,
        isHistorized:0,
        id: false,
        daily:{
          show: false,
          state: 0,
          unit: '',
          text: 'CONSO JOUR',
          isHistorized:0,
          id: false,
        },
      },
      loads: {},
      grid: {
        animation_speed: 5,
        max_power: false,
        alert_power: false,
        isHistorized:0,
        id: false,
        daily: {
          show_sell: false,
          show_buy: false,
          buy_state: 0,
          buy_unit: '',
          buy_isHistorized: 0,
          buy_id: false,
          sell_state: 0,
          sell_unit: '',
          sell_isHistorized: 0,
          sell_id: false,
          text_sell: 'VENTE JOUR',
          text_buy: 'ACHAT JOUR'
        },
        energy_cost: false,
        power: 0,
        power_invert: false,
        power_unit:'W',
        status: 1,
        has_grid_power: false,         
      },
      aux: {
        type: 'gen',
        max_power: false,
        alert_power: false,
        status: 'on',
        power: 0,
        power_unit: 'W',
        animation_speed: 5,
        energy: false,
        isHistorized:0,
        id: false,
        daily:{
          show: false,
          text: 'PRODUCTION JOUR',
          state: 0,
          unit: '',
          isHistorized:0,
          id: false,
        },
      },
      persos: {}
    }
    ////////////////////////////////////////////////////////
    //////////////// PARAMETRES OPTIONNELS /////////////////
    ////////////////////////////////////////////////////////
    
    /////////////////////// DIVERS /////////////////////////
    if ('#Background#' != '#'+'Background#') document.documentElement.style.setProperty('--background#uid#', '#Background#')
    if ("#blink#" == 1) config#uid#.blink = true
    if ('#fontAlert#' != '#'+'fontAlert#' && '#fontAlert#' == '1') config#uid#.font_alert = true // TODO
    if ("#activateGauge#" != '#'+'activateGauge#' && "#activateGauge#" == '0') config#uid#.activateGauge = false
    if ("#activateShadow#" != '#'+'activateShadow#' && "#activateShadow#" == '1') document.getElementById("widget#uid#")?.classList.add("shadow#uid#") // TODO
    if ("#shadowStyle#" != '#'+'shadowStyle#') document.documentElement.style.setProperty('--shadow-#uid#', '#shadowStyle#') // TODO
    if ("#activateGaugeRatio#" != '#'+'activateGaugeRatio#' && "#activateGaugeRatio#" == '0') config#uid#.activateGaugeRatio = false
    if (is_numeric('#sizeGaugeRatio#')) document.documentElement.style.setProperty('--strokeGaugeRatio-#uid#', Math.min(Math.max(4, '#sizeGaugeRatio#'), 10))
    if ('#formatMillier#' == '1') config#uid#.formatMillier = true
    if ('#autoConversionUnit#' == '0') config#uid#.autoConversionUnit = false
    if (is_numeric('#truncValue#')) config#uid#.powerTrunc = Math.max(Math.min(parseInt('#truncValue#'), 3), 0)
    if ("#colorDanger#" != '#'+'colorDanger#') document.documentElement.style.setProperty('--color_alerte#uid#', '#colorDanger#')
    ////////////////////////// Solar ///////////////////////
    if (is_numeric('#pvMaxPower#')) config#uid#.solar.max_power = '#pvMaxPower#'
    if ("#dailySolarText#" != '#'+'dailySolarText#') config#uid#.solar.daily.text = "#dailySolarText#"
    if ("#solarColor#" != '#'+'solarColor#') document.documentElement.style.setProperty('--solar_colour#uid#', '#solarColor#')
    if ("#pvState0Color#" != '#'+'pvState0Color#') document.documentElement.style.setProperty('--solar_colour-0-#uid#', '#pvState0Color#')
    if (is_numeric('#solarAlertPower#')) config#uid#.solar.alert_power = '#solarAlertPower#'
    ////////////////////////// LOAD ////////////////////////
    if ("#loadAnimate#" != '#'+'loadAnimate#' && "#loadAnimate#" == '0') config#uid#.load.animate_load_enable = 0
    if ("#dailyLoadText#" != '#'+'dailyLoadText#') config#uid#.load.daily.text = "#dailyLoadText#"
    if (is_numeric('#loadMaxPower#')) config#uid#.load.max_power = '#loadMaxPower#'
    if (is_numeric('#loadAlertPower#')) config#uid#.load.alert_power = '#loadAlertPower#'
    if ("#loadColor#" != '#'+'loadColor#') document.documentElement.style.setProperty('--load_colour#uid#', '#loadColor#')
    if ("#force4Load#" == '1') config#uid#.load.force4load = true
    ////////////////////////// GRID ////////////////////////
    if ("#dailyGridSellText#" != '#'+'dailyGridSellText#') config#uid#.grid.daily.text_sell = "#dailyGridSellText#"
    if ("#dailyGridBuyText#" != '#'+'dailyGridBuyText#') config#uid#.grid.daily.text_buy = "#dailyGridBuyText#"
    if (is_numeric('#gridMaxPower#')) config#uid#.grid.max_power = '#gridMaxPower#'
    if ("#gridColor#" != '#'+'gridColor#') document.documentElement.style.setProperty('--grid_colour#uid#', '#gridColor#')
    if ("#gridSellColor#" != '#'+'gridSellColor#') document.documentElement.style.setProperty('--grid-sell-colour#uid#', '#gridSellColor#')
    if ("#gridBuyColor#" != '#'+'gridBuyColor#') document.documentElement.style.setProperty('--grid-buy-colour#uid#', '#gridBuyColor#')
    if ("#noGridColor#" != '#'+'noGridColor#') document.documentElement.style.setProperty('--no_grid_colour#uid#', '#noGridColor#')
    if ("#PowerInvert#" == '1') config#uid#.grid.power_invert = true
    if (is_numeric('#gridAlertPower#')) config#uid#.grid.alert_power = '#gridAlertPower#'
    ////////////////////////// BATTERY /////////////////////
    if ("#batteryIcon#" != '#'+'batteryIcon#') config#uid#.battery.icon = '#batteryIcon#'
    if ("#dailyBatteryChargeText#" != '#'+'dailyBatteryChargeText#') config#uid#.battery.daily.text_charge = "#dailyBatteryChargeText#"
    if ("#dailyBatteryDischargeText#" != '#'+'dailyBatteryDischargeText#') config#uid#.battery.daily.text_discharge = "#dailyBatteryDischargeText#"
    if (is_numeric('#batteryMaxPower#')) config#uid#.battery.max_power = '#batteryMaxPower#' // config#uid#.battery.energy
    if (is_numeric('#batteryAlertPower#')) config#uid#.battery.alert_power = '#batteryAlertPower#'
    if (is_numeric('#batteryCapacity#')) config#uid#.battery.capacity = '#batteryCapacity#'
    if (is_numeric('#batterySocShutdown#')) config#uid#.battery.soc.shutdown = '#batterySocShutdown#'
    if ("#mpptName#" != '#'+'mpptName#') config#uid#.battery.mppt.name = "#mpptName#"
    if (is_numeric('#batteryMpptMaxPower#')) config#uid#.battery.mppt.max_power = '#batteryMpptMaxPower#'
    if (is_numeric('#batteryMpptAlertPower#')) config#uid#.battery.mppt.alert_power = '#batteryMpptAlertPower#'
    if ("#batteryColor#" != '#'+'batteryColor#') document.documentElement.style.setProperty('--battery_colour#uid#', '#batteryColor#')
    if ("#batteryStateColor#" != '#'+'batteryStateColor#') document.documentElement.style.setProperty('--battery-state#uid#', '#batteryStateColor#') // TODO
    if ("#batteryChargeColor#" != '#'+'batteryChargeColor#') document.documentElement.style.setProperty('--battery-charge#uid#', '#batteryChargeColor#')
    if ("#batteryDischargeColor#" != '#'+'batteryDischargeColor#') document.documentElement.style.setProperty('--battery-discharge#uid#', '#batteryDischargeColor#')
    if ("#autoColorBattery#" == '0') config#uid#.battery.autoColorBattery = false // TODO
    if ("#batteryState0Color#" != '#'+'batteryState0Color#') document.documentElement.style.setProperty('--battery-state-0-#uid#', '#batteryState0Color#')
    if ("#batteryState25Color#" != '#'+'batteryState25Color#') document.documentElement.style.setProperty('--battery-state-25-#uid#', '#batteryState25Color#')
    if ("#batteryState50Color#" != '#'+'batteryState50Color#') document.documentElement.style.setProperty('--battery-state-50-#uid#', '#batteryState50Color#')
    if ("#batteryState75Color#" != '#'+'batteryState75Color#') document.documentElement.style.setProperty('--battery-state-75-#uid#', '#batteryState75Color#')
    if ("#batteryState100Color#" != '#'+'batteryState100Color#') document.documentElement.style.setProperty('--battery-state-100-#uid#', '#batteryState100Color#')
    if ("#batteryMpptColor#" != '#'+'batteryMpptColor#') document.documentElement.style.setProperty('--battery_mppt_colour#uid#', '#batteryMpptColor#')
    if ("#batteryPowerInvert#" == '1') config#uid#.battery.power_invert = true
    //////////////////////// INVERTER //////////////////////
    if ("#inverterColor#" != '#'+'inverterColor#') document.documentElement.style.setProperty('--inverter_colour#uid#', '#inverterColor#')
    if ("#inverterColorTextIn#" != '#'+'inverterColorTextIn#') document.documentElement.style.setProperty('--inverter_secondary_colour#uid#', '#inverterColorTextIn#')
    if ("#inverterModel#" != '#'+'inverterModel#') config#uid#.inverter.model = '#inverterModel#'
    ////////////////////////// AUX /////////////////////////
    if ("#auxColor#" != '#'+'auxColor#') document.documentElement.style.setProperty('--aux_colour#uid#', '#auxColor#')
    if (is_numeric('#auxMaxPower#')) config#uid#.aux.max_power = '#auxMaxPower#'
    if (is_numeric('#auxAlertPower#')) config#uid#.aux.alert_power = '#auxAlertPower#'
    if ("#dailyAuxText#" != '#'+'dailyAuxText#') config#uid#.aux.daily.text = "#dailyAuxText#"
      
    ////////////////////////////////////////////////////////
    //////////////////////// GRID //////////////////////////
    ////////////////////////////////////////////////////////
    
    ///  GRID POWER  \\\
    if ('#grid_power_cmd#' != '#' + 'grid_power_cmd#') {
      jeedom.cmd.byId({
        id: '#grid_power_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.grid.isHistorized = cmd.isHistorized
          config#uid#.grid.id = cmd.id
          config#uid#.grid.power_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(powerValue) {
              if (config#uid#.grid.power_invert) {
                config#uid#.grid.power = isNaN(parseFloat(powerValue)) ? 0 : parseFloat(powerValue * -1)
              } else {
                config#uid#.grid.power = isNaN(parseFloat(powerValue)) ? 0 : parseFloat(powerValue)
              }
              if (config#uid#.grid.power_unit == 'kW') {
                config#uid#.grid.power = config#uid#.grid.power * 1000
                config#uid#.grid.power_unit = 'W'
              }
              config#uid#.has_grid = true
              config#uid#.grid.has_grid_power = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (config#uid#.grid.power_invert) {
                  config#uid#.grid.power = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value * -1)
                } else {
                  config#uid#.grid.power = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                }
                if (_options.raw_unit == 'kW') {
                  config#uid#.grid.power = config#uid#.grid.power * 1000
                }
                if (is_object(cmd = document.getElementById("grid-power-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let power = autoValueArray#uid#(config#uid#.grid.power, config#uid#.grid.power_unit)
                    let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                  } else {
                    let PowerAbs = trunc#uid#(Math.abs(config#uid#.grid.power), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.grid.power_unit
                  }
                }
                calculateGrid#uid#('grid power')
              })
            }
          })
        }
      })
    }
    ///  GRID STATUS  \\\
    if ('#grid_status_cmd#' != '#' + 'grid_status_cmd#') {
      jeedom.cmd.byId({
        id: '#grid_status_cmd#',
        async: false,
        success: function(cmd) {
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(gridStatus) {
              config#uid#.has_grid = true
              if (gridStatus == 0 || gridStatus == '0' || gridStatus == 'off') config#uid#.grid.status = 0
              else config#uid#.grid.status = 1
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (_options.value == 0 || _options.value == '0' || _options.value == 'off') {
                  config#uid#.grid.status = 0
                  if (config#uid#.blink) document.getElementById("grid-transmission-off-#uid#")?.classList.add("blink#uid#")
                  document.getElementById("grid-transmission-on-#uid#")?.classList.add("hidden-#uid#")
                  document.getElementById("grid-transmission-off-#uid#")?.classList.add("no_grid#uid#")
                  document.getElementById("grid-transmission-off-#uid#")?.classList.remove("hidden-#uid#")
                } else {
                  config#uid#.grid.status = 1
                  if (config#uid#.blink) document.getElementById("grid-transmission-off-#uid#")?.classList.remove("blink#uid#")
                  document.getElementById("grid-transmission-off-#uid#")?.classList.remove("no_grid#uid#")
                  if (config#uid#.grid.has_grid_power) calculateGrid#uid#('grid status')           
                }
              })
            }
          })
        }
      })
    }
    ///  GRID DAILY BUY  \\\
    if ('#grid_daily_buy_cmd#' != '#' + 'grid_daily_buy_cmd#') {
      jeedom.cmd.byId({
        id: '#grid_daily_buy_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.grid.daily.buy_isHistorized = cmd.isHistorized
          config#uid#.grid.daily.buy_id = cmd.id
          config#uid#.grid.daily.buy_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(dailyValue) {
              config#uid#.grid.daily.buy_state = isNaN(parseFloat(dailyValue)) ? 0 : parseFloat(dailyValue)
              config#uid#.grid.daily.show_buy = true
              config#uid#.has_grid = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (is_object(cmd = document.getElementById("grid-daily-buy-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let daily = autoValueArray#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.grid.daily.buy_unit)
                    let dailyAbs = trunc#uid#(Math.abs(daily.value), 3, 1)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + daily.unit
                  } else {
                    let dailyAbs = trunc#uid#(Math.abs((_options.value != undefined) ? parseFloat(_options.value) : 0), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.grid.daily.buy_unit
                  }
                }
              })  
            }
          })
        }
      })
    }
    ///  GRID DAILY SELL  \\\
    if ('#grid_daily_sell_cmd#' != '#' + 'grid_daily_sell_cmd#') {
      jeedom.cmd.byId({
        id: '#grid_daily_sell_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.grid.daily.sell_isHistorized = cmd.isHistorized
          config#uid#.grid.daily.sell_id = cmd.id
          config#uid#.grid.daily.sell_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(dailyValue) {
              config#uid#.grid.daily.sell_state = isNaN(parseFloat(dailyValue)) ? 0 : parseFloat(dailyValue)
              config#uid#.grid.daily.show_sell = true
              config#uid#.has_grid = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (is_object(cmd = document.getElementById("grid-daily-sell-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let daily = autoValueArray#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.grid.daily.sell_unit)
                    let dailyAbs = trunc#uid#(Math.abs(daily.value), 3, 1)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + daily.unit
                  } else {
                    let dailyAbs = trunc#uid#(Math.abs((_options.value != undefined) ? parseFloat(_options.value) : 0), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.grid.daily.sell_unit
                  }
                }
              })  
            }
          })
        }
      })
    }
    ////////////////////////////////////////////////////////
    ////////////////////// BATTERY /////////////////////////
    ////////////////////////////////////////////////////////
    
    ///  BATTERY POWER  \\\
    if ('#battery_power_cmd#' != '#' + 'battery_power_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_power_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.power.isHistorized = cmd.isHistorized
          config#uid#.battery.power.id = cmd.id
          config#uid#.battery.power.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(powerValue) {
              if (config#uid#.battery.power_invert) {
                config#uid#.battery.power.state = isNaN(parseFloat(powerValue)) ? 0 : parseFloat(powerValue * -1)
              } else {
                config#uid#.battery.power.state = isNaN(parseFloat(powerValue)) ? 0 : parseFloat(powerValue)
              }
              if (config#uid#.battery.power.unit == 'kW') {
                config#uid#.battery.power.state = config#uid#.battery.power.state * 1000
                config#uid#.battery.power.unit = 'W'
              }
              config#uid#.has_battery = true
              config#uid#.battery.power.show = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.battery.power.state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (config#uid#.battery.power_invert) {
                  config#uid#.battery.power.state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value * -1)
                } else {
                  config#uid#.battery.power.state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                }
                if (_options.raw_unit == 'kW') {
                  config#uid#.battery.power.state = config#uid#.battery.power.state * 1000
                }
                if (is_object(cmd = document.getElementById("battery-power-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let power = autoValueArray#uid#(config#uid#.battery.power.state, config#uid#.battery.power.unit)
                    let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                  } else {
                    let PowerAbs = trunc#uid#(Math.abs(config#uid#.battery.power.state), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.power.unit
                  }
                }
                if (config#uid#.has_battery) calculateBattery#uid#('battery power')
              })
            }
          })
        }
      })
    }
    ///  BATTERY VOLTAGE  \\\
    if ('#battery_voltage_cmd#' != '#' + 'battery_voltage_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_voltage_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.voltage.isHistorized = cmd.isHistorized
          config#uid#.battery.voltage.id = cmd.id
          config#uid#.battery.voltage.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.battery.voltage.state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              config#uid#.battery.voltage.show = true
              config#uid#.has_battery = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.battery.voltage.state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("battery-voltage-#uid#"))) {
                  let batteryVoltage = trunc#uid#(config#uid#.battery.voltage.state, config#uid#.powerTrunc)
                  cmd.innerHTML = formatMillier(batteryVoltage, config#uid#.formatMillier) + ' ' + config#uid#.battery.voltage.unit
                }
              })
            }
          })
        }
      })
    }
    ///  BATTERY CURRENT  \\\
    if ('#battery_current_cmd#' != '#' + 'battery_current_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_current_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.current.isHistorized = cmd.isHistorized
          config#uid#.battery.current.id = cmd.id
          config#uid#.battery.current.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.battery.current.state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              config#uid#.battery.current.show = true
              config#uid#.has_battery = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.battery.current.state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("battery-current-#uid#"))) {
                  let batteryCurrent = trunc#uid#(config#uid#.battery.current.state, config#uid#.powerTrunc)
                  cmd.innerHTML = formatMillier(batteryCurrent, config#uid#.formatMillier) + ' ' + config#uid#.battery.current.unit
                }
              })
            }
          })
        }
      })
    }
    ///  BATTERY TEMP  \\\
    if ('#battery_temp_cmd#' != '#' + 'battery_temp_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_temp_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.temp.isHistorized = cmd.isHistorized
          config#uid#.battery.temp.id = cmd.id
          config#uid#.battery.temp.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.battery.temp.state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              config#uid#.battery.temp.show = true
              config#uid#.has_battery = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.battery.temp.state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("battery-temp-#uid#"))) {
                  let batteryTemp = trunc#uid#(config#uid#.battery.temp.state, config#uid#.powerTrunc)
                  cmd.innerHTML = formatMillier(batteryTemp, config#uid#.formatMillier) + ' ' + config#uid#.battery.temp.unit
                }
              })
            }
          })
        }
      })
    }
    ///  BATTERY SOC  \\\
    if ('#battery_soc_cmd#' != '#' + 'battery_soc_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_soc_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.state.isHistorized = cmd.isHistorized
          config#uid#.battery.state.id = cmd.id
          config#uid#.battery.state.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(stateValue) {
              config#uid#.battery.state.state = isNaN(parseFloat(stateValue)) ? 100 : parseFloat(stateValue)
              config#uid#.battery.state.show = true
              config#uid#.has_battery = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.battery.state.state = isNaN(parseFloat(_options.value)) ? 100 : parseFloat(_options.value)
                if (config#uid#.has_battery) calculateBattery#uid#('battery state')
              })
            }
          })
        }
      })
    }
    ///  BATTERY DAILY CHARGE  \\\
    if ('#battery_daily_charge_cmd#' != '#' + 'battery_daily_charge_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_daily_charge_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.daily.charge_isHistorized = cmd.isHistorized
          config#uid#.battery.daily.charge_id = cmd.id
          config#uid#.battery.daily.charge_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(dailyValue) {
              config#uid#.battery.daily.charge_state = isNaN(parseFloat(dailyValue)) ? 0 : parseFloat(dailyValue)
              config#uid#.battery.daily.show_charge = true
              config#uid#.has_battery = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (is_object(cmd = document.getElementById("battery-daily-charge-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let daily = autoValueArray#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.battery.daily.charge_unit)
                    let dailyAbs = trunc#uid#(daily.value, config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + daily.unit
                  } else {
                    let dailyAbs = trunc#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.daily.charge_unit
                  }
                }
              })  
            }
          })
        }
      })
    }
    ///  BATTERY DAILY DISCHARGE  \\\
    if ('#battery_daily_discharge_cmd#' != '#' + 'battery_daily_discharge_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_daily_discharge_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.daily.discharge_isHistorized = cmd.isHistorized
          config#uid#.battery.daily.discharge_id = cmd.id
          config#uid#.battery.daily.discharge_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(dailyValue) {
              config#uid#.battery.daily.discharge_state = isNaN(parseFloat(dailyValue)) ? 0 : parseFloat(dailyValue)
              config#uid#.battery.daily.show_discharge = true
              config#uid#.has_battery = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (is_object(cmd = document.getElementById("battery-daily-discharge-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let daily = autoValueArray#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.battery.daily.discharge_unit)
                    let dailyAbs = trunc#uid#(daily.value, config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + daily.unit
                  } else {
                    let dailyAbs = trunc#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.daily.discharge_unit
                  }
                }
              })  
            }
          })
        }
      })
    }
    ///  BATTERY MPPT POWER  \\\
    if ('#battery_mppt_power_cmd#' != '#' + 'battery_mppt_power_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_mppt_power_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.mppt.has_mppt_power = true
          config#uid#.battery.mppt.power.show = true
          config#uid#.battery.mppt.power.isHistorized = cmd.isHistorized
          config#uid#.battery.mppt.power.id = cmd.id
          config#uid#.battery.mppt.power.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(power) {
              config#uid#.battery.mppt.power.state = isNaN(parseFloat(power)) ? 0 : Math.abs(parseFloat(power))
              if (config#uid#.battery.mppt.power.unit == 'kW') {
                config#uid#.battery.mppt.power.state = config#uid#.battery.mppt.power.state * 1000
                config#uid#.battery.mppt.power.unit = 'W'
              }
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.battery.mppt.power.state = isNaN(parseFloat(_options.value)) ? 0 : Math.abs(parseFloat(_options.value))
                if (_options.raw_unit == 'kW') {
                  config#uid#.battery.mppt.power.state = config#uid#.battery.mppt.power.state * 1000
                }
                if (is_object(cmd = document.getElementById("battery-mppt-power-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let power = autoValueArray#uid#(config#uid#.battery.mppt.power.state, config#uid#.battery.mppt.power.unit)
                    let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                  } else {
                    let PowerAbs = trunc#uid#(Math.abs(config#uid#.battery.mppt.power.state), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.mppt.power.unit
                  }
                  if (config#uid#.battery.mppt.power.state > 0) document.getElementById("battery-mppt-dot-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                  else document.getElementById("battery-mppt-dot-#uid#")?.setAttribute("fill", "transparent")
                  calculateBattery#uid#('battery mppt power')
                }
              })  
            }
          })
        }
      })
    }
    ///  BATTERY MPPT ENERGY  \\\
    if ('#battery_mppt_energy_cmd#' != '#' + 'battery_mppt_energy_cmd#') {
      jeedom.cmd.byId({
        id: '#battery_mppt_energy_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.battery.mppt.energy.show = true
          config#uid#.battery.mppt.energy.isHistorized = cmd.isHistorized
          config#uid#.battery.mppt.energy.id = cmd.id
          config#uid#.battery.mppt.energy.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(energy) {
              config#uid#.battery.mppt.energy.state = isNaN(parseFloat(energy)) ? 0 : parseFloat(energy)
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.battery.mppt.energy.state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (config#uid#.has_battery && is_object(cmd = document.getElementById("battery-mppt-daily-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let mppt_energy = autoValueArray#uid#(config#uid#.battery.mppt.energy.state, config#uid#.battery.mppt.energy.unit)
                    let mppt_energyAbs = trunc#uid#(Math.abs(mppt_energy.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(mppt_energyAbs, config#uid#.formatMillier) + ' ' + mppt_energy.unit
                  } else {
                    let mppt_energyAbs = trunc#uid#(Math.abs(config#uid#.battery.mppt.energy.state), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(mppt_energyAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.mppt.energy.unit
                  }
                }
              })  
            }
          })
        }
      })
    }
    ////////////////////////////////////////////////////////
    /////////////////////// SOLAR //////////////////////////
    ////////////////////////////////////////////////////////
    
    ///  SOLAR POWER  \\\
    if ('#solar_power_cmd#' != '#' + 'solar_power_cmd#') {
      jeedom.cmd.byId({
        id: '#solar_power_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.solar.isHistorized = cmd.isHistorized
          config#uid#.solar.id = cmd.id
          config#uid#.solar.power_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(powerValue) {
              config#uid#.solar.power = isNaN(parseFloat(powerValue)) ? 0 : Math.abs(parseFloat(powerValue))
              config#uid#.has_solar = true
              config#uid#.solar.has_pv_power = true
              if (config#uid#.solar.power_unit == 'kW') {
                config#uid#.solar.power = config#uid#.solar.power * 1000
                config#uid#.solar.power_unit = 'W'
              }
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.solar.power = isNaN(parseFloat(_options.value)) ? 0 : Math.abs(parseFloat(_options.value))
                if (_options.raw_unit == 'kW') {
                  config#uid#.solar.power = config#uid#.solar.power * 1000
                }
                if (is_object(cmd = document.getElementById("pv-power-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let power = autoValueArray#uid#(config#uid#.solar.power, config#uid#.solar.power_unit)
                    let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                  } else {
                    let PowerAbs = trunc#uid#(Math.abs(config#uid#.solar.power), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.solar.power_unit
                  }
                  if (config#uid#.has_solar) calculatePv#uid#('pv_power')
                }
              })
            }
          })
        }
      })
    }
    ///  SOLAR DAILY  \\\
    if ('#solar_daily_cmd#' != '#' + 'solar_daily_cmd#') {
      jeedom.cmd.byId({
        id: '#solar_daily_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.solar.daily.isHistorized = cmd.isHistorized
          config#uid#.solar.daily.id = cmd.id
          config#uid#.solar.daily.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(dailyValue) {
              config#uid#.solar.daily.state = isNaN(parseFloat(dailyValue)) ? 0 : parseFloat(dailyValue)
              config#uid#.solar.daily.show = true
              config#uid#.has_solar = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (is_object(cmd = document.getElementById("pv-daily-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let daily = autoValueArray#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.solar.daily.unit)
                    let dailyAbs = trunc#uid#(Math.abs(daily.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + daily.unit
                  } else {
                    let dailyAbs = trunc#uid#(Math.abs((_options.value != undefined) ? parseFloat(_options.value) : 0), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.solar.daily.unit
                  }
                }
              }) 
            }
          })
        }
      })
    }
    ///  SOLAR PVs  \\\
    if ('#pvarray#' != '#' + 'pvarray#') {
      var obj = JSON.parse(JSON.stringify(#pvarray#))
      config#uid#.solar.mppts = Object.keys(obj).length
      for (j in obj) {
        config#uid#.solars[j] = {}
        config#uid#.solars[j].voltage = false
        config#uid#.solars[j].current = false
        config#uid#.solars[j].energy = false
        config#uid#.solars[j].power = 0
        for (k in Object.keys(obj[j])) {
          let key = Object.keys(obj[j])[k]
          let num = j
          if (key == 'max_power') {
            config#uid#.solars[j].max_power = isNaN(parseInt(obj[j][key])) ? false : Math.abs(parseInt(obj[j][key]))
            continue;
          }
          if (key == 'max_alert') {
            config#uid#.solars[j].max_alert = isNaN(parseInt(obj[j][key])) ? false : Math.abs(parseInt(obj[j][key]))
            continue;
          }
          if (key == 'name') {
            config#uid#.solars[j].name = obj[j][key]
            continue;
          }
          let type = key.split('::')
          let id = obj[j][key]
          jeedom.cmd.byId({
            id: parseInt(obj[j][key]),
            async: false,
            success:  function(cmd) {
              config#uid#.solars[j][type[0] + '_unit'] = cmd.unite
              config#uid#.solars[j][type[0] + '_isHistorized'] = cmd.isHistorized
              config#uid#.solars[j][type[0] + '_id'] = cmd.id
              jeedom.cmd.execute({
                id: parseInt(obj[j][key]),
                async: false,
                success:  function(pvValue) {
                  config#uid#.has_solar = true
                  if (type[0] == 'power') {
                    config#uid#.solars[j][type[0]] = isNaN(parseFloat(pvValue)) ? 0 : Math.abs(parseFloat(pvValue))
                    if (config#uid#.solars[j]['power_unit'] == 'kW') {
                      config#uid#.solars[j]['power'] = config#uid#.solars[j]['power'] * 1000
                      config#uid#.solars[j]['power_unit'] = 'W'
                    }
                  } else if (type[0] == 'energy') {
                    config#uid#.solars[j][type[0]] = isNaN(parseFloat(pvValue)) ? 0 : Math.abs(parseFloat(pvValue))
                  } else {
                    config#uid#.solars[j][type[0]] = isNaN(parseFloat(pvValue)) ? 0 : parseFloat(pvValue)
                  }
                  jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                    if (type[0] == 'energy') {
                      config#uid#.solars[num]['energy'] = isNaN(parseFloat(_options.value)) ? 0 : Math.abs(parseFloat(_options.value))
                      if (is_object(cmd = document.getElementById("pv" + num + "-daily-#uid#"))) {
                        if (config#uid#.autoConversionUnit) {
                          let energy = autoValueArray#uid#(config#uid#.solars[num]['energy'], config#uid#.solars[num]['energy_unit'])
                          let energyAbs = trunc#uid#(Math.abs(energy.value), config#uid#.powerTrunc)
                          cmd.innerHTML = formatMillier(energyAbs, config#uid#.formatMillier) + ' ' + energy.unit
                        } else {
                          let energyAbs = trunc#uid#(Math.abs(config#uid#.solars[num]['energy']), config#uid#.powerTrunc)
                          cmd.innerHTML = formatMillier(energyAbs, config#uid#.formatMillier) + ' ' + config#uid#.solars[num]['energy_unit']
                        }
                        
                      }
                    } else if (type[0] == 'power') {
                      config#uid#.solars[num]['power'] = isNaN(parseFloat(_options.value)) ? 0 : Math.abs(parseFloat(_options.value))
                      if (_options.raw_unit == 'kW') {
                        config#uid#.solars[num]['power'] = config#uid#.solars[num]['power'] * 1000
                      }
                      if (is_object(cmd = document.getElementById("pv" + num + "-power-#uid#"))) {
                        ///  POWER  \\\
                        if (config#uid#.autoConversionUnit) {
                          let power = autoValueArray#uid#(config#uid#.solars[num]['power'], config#uid#.solars[num]['power_unit'])
                          let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                          cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                        } else {
                          let PowerAbs = trunc#uid#(Math.abs(config#uid#.solars[num]['power']), config#uid#.powerTrunc)
                          cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.solars[num]['power_unit']
                        }
                        ///  DOT  \\\
                        if (config#uid#.solars[num]['power'] > 0) {
                          document.getElementById("pv" + num + "-dot-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                        } else {
                          document.getElementById("pv" + num + "-dot-#uid#")?.setAttribute("fill", "transparent")
                        }
                        ///  COLOR  \\\
                        if ("#pvState0Color#" != '#'+'pvState0Color#' && '#pvState0Color#' != '#solarColor#') {
                          if (config#uid#.solars[num].power > 0) {
                            document.getElementById("pv" + num + "-line-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
                            if (is_object(document.getElementById("pv" + num + "-line-#uid#"))) document.getElementById("pv" + num + "-line-#uid#").style.opacity = 1
                            document.getElementById("pv" + num + "-voltage-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                            document.getElementById("pv" + num + "-current-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                            document.getElementById("pv" + num + "-daily-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                            document.getElementById("pv" + num + "-name-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                          } else {
                            document.getElementById("pv" + num + "-line-#uid#")?.setAttribute("stroke", "var(--solar_colour-0-#uid#)")
                            if (is_object(document.getElementById("pv" + num + "-line-#uid#"))) document.getElementById("pv" + num + "-line-#uid#").style.opacity = 0.2
                            document.getElementById("pv" + num + "-voltage-#uid#")?.setAttribute("fill", "var(--solar_colour-0-#uid#)")
                            document.getElementById("pv" + num + "-current-#uid#")?.setAttribute("fill", "var(--solar_colour-0-#uid#)")
                            document.getElementById("pv" + num + "-daily-#uid#")?.setAttribute("fill", "var(--solar_colour-0-#uid#)")
                            document.getElementById("pv" + num + "-name-#uid#")?.setAttribute("fill", "var(--solar_colour-0-#uid#)")
                          }
                        }
                        ///  ALERT  \\\
                        if (isset(config#uid#.solars[num].max_alert) && config#uid#.solars[num].max_alert && config#uid#.solars[num][type[0]] >= config#uid#.solars[num].max_alert) {
                          document.getElementById("pv" + num + "-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
                          if (config#uid#.blink) {
                            document.getElementById("pv" + num + "-rect-gauge-#uid#")?.classList.add("blink#uid#")
                            document.getElementById("pv" + num + "-rect-#uid#")?.classList.add("blink#uid#")
                          }
                          if (config#uid#.font_alert) document.getElementById("pv" + num + "-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
                        } else {
                          if (config#uid#.solars[num].power > 0) {
                            document.getElementById("pv" + num + "-rect-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
                            document.getElementById("pv" + num + "-power-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                          } else {
                            document.getElementById("pv" + num + "-rect-#uid#")?.setAttribute("stroke", "var(--solar_colour-0-#uid#)")
                            document.getElementById("pv" + num + "-power-#uid#")?.setAttribute("fill", "var(--solar_colour-0-#uid#)")
                          }
                          if (config#uid#.blink) {
                            document.getElementById("pv" + num + "-rect-gauge-#uid#")?.classList.remove("blink#uid#")
                            document.getElementById("pv" + num + "-rect-#uid#")?.classList.remove("blink#uid#")
                          }
                        }
                        ///  GAUGE  \\\
                        if (isset(config#uid#.solars[num].max_power) && config#uid#.solars[num].max_power && config#uid#.activateGauge) {
                          let gaugePourcent = config#uid#.solars[num][type[0]] * 100 / config#uid#.solars[num].max_power
                          let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
                          document.getElementById("pv" + num + "-rect-gauge-#uid#")?.setAttribute('width', width_rect_gauge)
                        } else document.getElementById("pv" + num + "-rect-gauge-#uid#")?.setAttribute('width', 0)
                        ///  CALCULATE  \\\
                        if (config#uid#.has_solar) calculatePv#uid#('pv' + num + '_power')
                      }
                    } else {
                      config#uid#.solars[num][type[0]] = isNaN(parseFloat(_options.value)) ? 0 : Math.abs(parseFloat(_options.value))
                      if (is_object(cmd = document.getElementById("pv" + num + "-" + type[0] + "-#uid#"))) {
                        cmd.innerHTML = formatMillier(trunc#uid#(parseFloat(_options.value), config#uid#.powerTrunc), config#uid#.formatMillier) + ' ' + config#uid#.solars[num][type[0] + '_unit']
                      }
                    }
                  })
                }
              })
            }
          })
        }
      }
    }
    ////////////////////////////////////////////////////////
    //////////////////////// LOAD //////////////////////////
    ////////////////////////////////////////////////////////
    
    ///  POWER  \\\
    if ('#load_power_cmd#' != '#' + 'load_power_cmd#') {
      jeedom.cmd.byId({
        id: '#load_power_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.load.isHistorized = cmd.isHistorized
          config#uid#.load.id = cmd.id
          config#uid#.load.power_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(powerValue) {
              config#uid#.load.power = isNaN(parseFloat(powerValue)) ? 0 : Math.abs(parseFloat(powerValue))
              config#uid#.has_load = true
              config#uid#.load.has_load_power = true
              if (config#uid#.load.power_unit == 'kW') {
                config#uid#.load.power = config#uid#.load.power * 1000
                config#uid#.load.power_unit = 'W'
              }
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.load.power = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (_options.raw_unit == 'kW') {
                  config#uid#.load.power = config#uid#.load.power * 1000
                }
                if (is_object(cmd = document.getElementById("load-power-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let power = autoValueArray#uid#(config#uid#.load.power, config#uid#.load.power_unit)
                    let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                  } else {
                    let PowerAbs = trunc#uid#(Math.abs(config#uid#.load.power), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.load.power_unit
                  }
                }
                /*
                if (config#uid#.load.max_power && config#uid#.load.power >= config#uid#.load.max_power) {
                  document.getElementById("load-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
                  if (config#uid#.blink) document.getElementById("load-rect-#uid#")?.classList.add("blink#uid#")
                } else {
                  document.getElementById("load-rect-#uid#")?.setAttribute("stroke", "var(--load_colour#uid#)")
                  if (config#uid#.blink) document.getElementById("load-rect-#uid#")?.classList.remove("blink#uid#")
                }
                */
                if (config#uid#.has_load) calculateLoad#uid#('load state')
              })
            }
          })
        }
      })
    }
    ///  DAILY  \\\
    if ('#load_daily_cmd#' != '#' + 'load_daily_cmd#') {
      jeedom.cmd.byId({
        id: '#load_daily_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.load.daily.isHistorized = cmd.isHistorized
          config#uid#.load.daily.id = cmd.id
          config#uid#.load.daily.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(dailyValue) {
              config#uid#.load.daily.state = isNaN(parseFloat(dailyValue)) ? 0 : parseFloat(dailyValue)
              config#uid#.load.daily.show = true
              config#uid#.has_load = true
                            jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (is_object(cmd = document.getElementById("load-daily-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let daily = autoValueArray#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.load.daily.unit)
                    let dailyAbs = trunc#uid#(Math.abs(daily.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + daily.unit
                  } else {
                    let dailyAbs = trunc#uid#(Math.abs((_options.value != undefined) ? parseFloat(_options.value) : 0), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.load.daily.unit
                  }
                }
              })
            }
          })
        }
      })
    }
    ///  LOADS  \\\
    if ('#loadarray#' != '#' + 'loadarray#') {
      var obj = JSON.parse(JSON.stringify(#loadarray#))
      config#uid#.load.additional_loads = Object.keys(obj).length
      for (j in obj) {
        config#uid#.loads[j] = {}
        config#uid#.loads[j].perso = false
        config#uid#.loads[j].energy = false
        config#uid#.loads[j].power = 0
        for (k in Object.keys(obj[j])) {
          let key = Object.keys(obj[j])[k]
          let num = j
          if (key == 'max_power') {
            config#uid#.loads[j].max_power = isNaN(parseInt(obj[j][key])) ? false : parseInt(obj[j][key])
            continue;
          }
          if (key == 'max_alert') {
            config#uid#.loads[j].max_alert = isNaN(parseInt(obj[j][key])) ? false : Math.abs(parseInt(obj[j][key]))
            continue;
          }
          if (key == 'name') {
            config#uid#.loads[j].name = obj[j][key]
            continue;
          }
          if (key == 'icon') {
            config#uid#.loads[j].icon = obj[j][key]
            continue;
          }
          let type = key.split('::')
          let id = obj[j][key]
          jeedom.cmd.byId({
            id: parseInt(obj[j][key]),
            async: false,
            success:  function(cmd) {
              config#uid#.loads[j][type[0] + '_unit'] = cmd.unite
              config#uid#.loads[j][type[0] + '_isHistorized'] = cmd.isHistorized
              config#uid#.loads[j][type[0] + '_id'] = cmd.id
              jeedom.cmd.execute({
                id: parseInt(obj[j][key]),
                async: false,
                success:  function(loadValue) {
                  config#uid#.has_load = true
                  if (type[0] == 'power') {
                    config#uid#.loads[j][type[0]] = isNaN(parseFloat(loadValue)) ? 0 : Math.abs(parseFloat(loadValue))
                    if (config#uid#.loads[j]['power_unit'] == 'kW') {
                      config#uid#.loads[j]['power'] = config#uid#.loads[j]['power'] * 1000
                      config#uid#.loads[j]['power_unit'] = 'W'
                    }
                  } else if (type[0] == 'energy') {
                    config#uid#.loads[j][type[0]] = isNaN(parseFloat(loadValue)) ? 0 : Math.abs(parseFloat(loadValue))
                  } else {
                    config#uid#.loads[j][type[0]] = is_numeric(loadValue) ? parseFloat(loadValue) : loadValue
                  }
                  jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                    if (type[0] == 'energy') {
                      
                      config#uid#.loads[num]['energy'] = isNaN(parseFloat(_options.value)) ? 0 : Math.abs(parseFloat(_options.value))
                      if (is_object(energyCmd = document.getElementById("load" + num + "-daily-#uid#"))) {
                        if (config#uid#.autoConversionUnit) {
                          let loadEnergy = autoValueArray#uid#(config#uid#.loads[num]['energy'], config#uid#.loads[num]['energy_unit'])
                          let PowerAbs = trunc#uid#(Math.abs(loadEnergy.value), config#uid#.powerTrunc)
                          energyCmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + loadEnergy.unit
                        } else {
                          let PowerAbs = trunc#uid#(Math.abs(config#uid#.loads[num]['energy']), config#uid#.powerTrunc)
                          energyCmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.loads[num]['energy_unit']
                        }
                      }
                    } else if (type[0] == 'power') {
                      ///  POWER  \\\
                      config#uid#.loads[num]['power'] = isNaN(parseFloat(_options.value)) ? 0 : Math.abs(parseFloat(_options.value))
                      if (_options.raw_unit == 'kW') {
                        config#uid#.loads[num]['power'] = config#uid#.loads[num]['power'] * 1000
                      }
                      if (is_object(powerCmd = document.getElementById("load" + num + "-power-#uid#"))) {
                        if (config#uid#.autoConversionUnit) {
                          let power = autoValueArray#uid#(config#uid#.loads[num]['power'], config#uid#.loads[num]['power_unit'])
                          let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                          powerCmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                        } else {
                          let PowerAbs = trunc#uid#(Math.abs(config#uid#.loads[num]['power']), config#uid#.powerTrunc)
                          powerCmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.loads[num]['power_unit']
                        }
                      }
                      ///  DOT  \\\
                      if (config#uid#.loads[num]['power'] > 0) document.getElementById("load" + num + "-dot-#uid#")?.setAttribute("fill", "var(--load_colour#uid#)")
                      else document.getElementById("load" + num + "-dot-#uid#")?.setAttribute("fill", "transparent")
                      ///  ALERT  \\\
                      if (isset(config#uid#.loads[num].max_alert) && config#uid#.loads[num].max_alert && config#uid#.loads[num].power >= config#uid#.loads[num].max_alert) {
                        document.getElementById("load" + num + "-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
                        if (config#uid#.font_alert) document.getElementById("load" + num + "-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
                        if (config#uid#.blink) {
                          document.getElementById("load" + num + "-rect-#uid#")?.classList.add("blink#uid#")
                          document.getElementById("load" + num + "-rect-gauge-#uid#")?.classList.add("blink#uid#")
                          if (config#uid#.font_alert) document.getElementById("load" + num + "-power-#uid#").classList.add("blink#uid#")
                        }
                      } else {
                        document.getElementById("load" + num + "-rect-#uid#")?.setAttribute("stroke", "var(--load_colour#uid#)")
                        if (config#uid#.font_alert) document.getElementById("load" + num + "-power-#uid#")?.setAttribute("fill", "var(--load_colour#uid#)")
                        if (config#uid#.blink) {
                          document.getElementById("load" + num + "-rect-#uid#")?.classList.remove("blink#uid#")
                          document.getElementById("load" + num + "-rect-gauge-#uid#")?.classList.remove("blink#uid#")
                          if (config#uid#.font_alert) document.getElementById("load" + num + "-power-#uid#")?.classList.remove("blink#uid#")
                        }
                      }
                      ///  GAUGE  \\\
                      if (isset(config#uid#.loads[num].max_power) && config#uid#.loads[num].max_power && config#uid#.activateGauge) {
                        let gaugePourcent = config#uid#.loads[num][type[0]] * 100 / config#uid#.loads[num].max_power
                        let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
                        document.getElementById("load" + num + "-rect-gauge-#uid#")?.setAttribute('width', width_rect_gauge)
                      } else document.getElementById("load" + num + "-rect-gauge-#uid#")?.setAttribute('width', 0)
                      ///  CALCULATE  \\\
                      if (config#uid#.load.has_load_power === false) calculateLoad#uid#('load' + num + ' state')
                    } else {
                      config#uid#.loads[num][type[0]] = _options.value
                      if (is_object(otherCmd = document.getElementById("load" + num + "_" + type[0] + "#uid#"))) {
                        otherCmd.innerHTML = (is_numeric(config#uid#.loads[num][type[0]]) ? formatMillier(trunc#uid#(config#uid#.loads[num][type[0]], config#uid#.powerTrunc), config#uid#.formatMillier) : config#uid#.loads[num][type[0]]) + ' ' + config#uid#.loads[num][type[0] + '_unit']
                      }
                    }
                  })
                }
              })
            }
          })
        }
      }
    }
    ////////////////////////////////////////////////////////
    ////////////////////// INVERTER ////////////////////////
    ////////////////////////////////////////////////////////
    
    ///  voltage  \\\
    if ('#inverter_voltage_cmd#' != '#' + 'inverter_voltage_cmd#') {
      jeedom.cmd.byId({
        id: '#inverter_voltage_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.inverter.voltage_isHistorized = cmd.isHistorized
          config#uid#.inverter.voltage_id = cmd.id
          config#uid#.inverter.voltage_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.inverter.voltage_state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.inverter.voltage_state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("inverter_voltage#uid#"))) {
                  cmd.innerHTML = trunc#uid#(config#uid#.inverter.voltage_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.voltage_unit
                }
              })  
            }
          })
        }
      })
    }
    ///  current  \\\
    if ('#inverter_current_cmd#' != '#' + 'inverter_current_cmd#') {
      jeedom.cmd.byId({
        id: '#inverter_current_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.inverter.current_isHistorized = cmd.isHistorized
          config#uid#.inverter.current_id = cmd.id
          config#uid#.inverter.current_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.inverter.current_state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.inverter.current_state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("inverter_current#uid#"))) {
                  cmd.innerHTML = trunc#uid#(config#uid#.inverter.current_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.current_unit
                }
              })  
            }
          })
        }
      })
    }
    ///  frequency  \\\
    if ('#inverter_frequency_cmd#' != '#' + 'inverter_frequency_cmd#') {
      jeedom.cmd.byId({
        id: '#inverter_frequency_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.inverter.frequency_isHistorized = cmd.isHistorized
          config#uid#.inverter.frequency_id = cmd.id
          config#uid#.inverter.frequency_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.inverter.frequency_state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.inverter.frequency_state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("inverter_frequency#uid#"))) {
                  cmd.innerHTML = trunc#uid#(config#uid#.inverter.frequency_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.frequency_unit
                }
              })  
            }
          })
        }
      })
    }
    ///  lcd  \\\
    if ('#inverter_lcd_cmd#' != '#' + 'inverter_lcd_cmd#') {
      jeedom.cmd.byId({
        id: '#inverter_lcd_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.inverter.lcd_isHistorized = cmd.isHistorized
          config#uid#.inverter.lcd_id = cmd.id
          config#uid#.inverter.lcd_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.inverter.lcd_state = value
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.inverter.lcd_state = _options.value
                if (is_object(cmd = document.getElementById("inverter_lcd#uid#"))) {
                  cmd.innerHTML = config#uid#.inverter.lcd_state + ' ' + config#uid#.inverter.lcd_unit
                }
              })  
            }
          })
        }
      })
    }
    ///  ac temp  \\\
    if ('#inverter_temp_ac_cmd#' != '#' + 'inverter_temp_ac_cmd#') {
      jeedom.cmd.byId({
        id: '#inverter_temp_ac_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.inverter.temp.ac_isHistorized = cmd.isHistorized
          config#uid#.inverter.temp.ac_id = cmd.id
          config#uid#.inverter.temp.ac_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.inverter.temp.ac_state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.inverter.temp.ac_state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("ac_temp#uid#"))) {
                  cmd.innerHTML = trunc#uid#(config#uid#.inverter.temp.ac_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.temp.ac_unit
                }
              })  
            }
          })
        }
      })
    }
    ///  dc temp  \\\
    if ('#inverter_temp_dc_cmd#' != '#' + 'inverter_temp_dc_cmd#') {
      jeedom.cmd.byId({
        id: '#inverter_temp_dc_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.inverter.temp.dc_isHistorized = cmd.isHistorized
          config#uid#.inverter.temp.dc_id = cmd.id
          config#uid#.inverter.temp.dc_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(value) {
              config#uid#.inverter.temp.dc_state = isNaN(parseFloat(value)) ? 0 : parseFloat(value)
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.inverter.temp.dc_state = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (is_object(cmd = document.getElementById("dc_temp#uid#"))) {
                  cmd.innerHTML = trunc#uid#(config#uid#.inverter.temp.dc_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.temp.dc_unit
                }
              })  
            }
          })
        }
      })
    }
    ////////////////////////////////////////////////////////
    ///////////////////////// AUX //////////////////////////
    ////////////////////////////////////////////////////////
    
    ///  POWER  \\\
    if ('#aux_power_cmd#' != '#' + 'aux_power_cmd#') {
      jeedom.cmd.byId({
        id: '#aux_power_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.aux.isHistorized = cmd.isHistorized
          config#uid#.aux.id = cmd.id
          config#uid#.aux.power_unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(powerValue) {
              config#uid#.aux.power = isNaN(parseFloat(powerValue)) ? 0 : parseFloat(powerValue)
              if (config#uid#.aux.power_unit == 'kW') {
                config#uid#.aux.power = config#uid#.aux.power * 1000
                config#uid#.aux.power_unit = 'W'
              }
              config#uid#.has_aux = true
              config#uid#.aux.has_aux_power = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                config#uid#.aux.power = isNaN(parseFloat(_options.value)) ? 0 : parseFloat(_options.value)
                if (_options.raw_unit == 'kW') {
                  config#uid#.aux.power = config#uid#.aux.power * 1000
                }
                if (is_object(cmd = document.getElementById("aux-power-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let power = autoValueArray#uid#(config#uid#.aux.power, config#uid#.aux.power_unit)
                    let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
                  } else {
                    let PowerAbs = trunc#uid#(Math.abs(config#uid#.aux.power), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.aux.power_unit
                  }
                }
                if (config#uid#.aux.max_power && config#uid#.aux.power >= config#uid#.aux.max_power) {
                  document.getElementById("aux-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
                  if (config#uid#.blink) document.getElementById("aux-rect-#uid#")?.classList.add("blink#uid#")
                } else {
                  document.getElementById("aux-rect-#uid#")?.setAttribute("stroke", "var(--load_colour#uid#)")
                  if (config#uid#.blink) document.getElementById("aux-rect-#uid#")?.classList.remove("blink#uid#")
                }
                if (config#uid#.has_aux) calculateAux#uid#('aux power')
              })
            }
          })
        }
      })
    }
    ///  DAILY  \\\
    if ('#aux_daily_cmd#' != '#' + 'aux_daily_cmd#') {
      jeedom.cmd.byId({
        id: '#aux_daily_cmd#',
        async: false,
        success:  function(cmd) {
          config#uid#.aux.daily.isHistorized = cmd.isHistorized
          config#uid#.aux.daily.id = cmd.id
          config#uid#.aux.daily.unit = cmd.unite
          jeedom.cmd.execute({
            id: cmd.id,
            async: false,
            success:  function(dailyValue) {
              config#uid#.aux.daily.state = isNaN(parseFloat(dailyValue)) ? 0 : parseFloat(dailyValue)
              config#uid#.aux.daily.show = true
              jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                if (is_object(cmd = document.getElementById("aux-daily-#uid#"))) {
                  if (config#uid#.autoConversionUnit) {
                    let daily = autoValueArray#uid#((_options.value != undefined) ? parseFloat(_options.value) : 0, config#uid#.aux.daily.unit)
                    let dailyAbs = trunc#uid#(Math.abs(daily.value), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + daily.unit
                  } else {
                    let dailyAbs = trunc#uid#(Math.abs((_options.value != undefined) ? parseFloat(_options.value) : 0), config#uid#.powerTrunc)
                    cmd.innerHTML = formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.aux.daily.unit
                  }
                }
              }) 
            }
          })
        }
      })
    }
      
    ////////////////////////////////////////////////////////
    //////////////////////// PERSO /////////////////////////
    ////////////////////////////////////////////////////////
    if ('#persoarray#' != '#' + 'persoarray#') {
      var obj = JSON.parse(JSON.stringify(#persoarray#))
      for (j in obj) {
        let cmd = obj[j]['perso::cmd']
        let params = obj[j]['params']
        let param = obj[j]['params'].split(",")
        let num = j
        //console.log('params : ' + params)
        jeedom.cmd.byId({
          id: cmd,
          async: false,
          success:  function(cmd) {
            jeedom.cmd.execute({
              id: parseInt(cmd.id),
              async: false,
              success:  function(persoValue) {
                let y_pos = parseFloat(param[1].trim())
                config#uid#.persos[j] = {}
                config#uid#.persos[j]['x_value'] = parseFloat(param[0])
                config#uid#.persos[j]['size_value'] = Math.min(16, parseFloat(param[2]))
                config#uid#.persos[j]['color'] = param[3]
                config#uid#.persos[j]['text'] = param[4]
                config#uid#.persos[j]['size_text'] = Math.min(16, parseFloat(param[5]))
                config#uid#.persos[j]['position'] = param[6]
                if (config#uid#.persos[j]['position'] == 'before') {
                  config#uid#.persos[j]['y_text'] = parseFloat(param[1])
                  config#uid#.persos[j]['y_value'] = config#uid#.persos[j]['y_text'] + config#uid#.persos[j]['size_value'] + 2
                } else {
                  config#uid#.persos[j]['y_value'] = parseFloat(param[1])
                  config#uid#.persos[j]['y_text'] = config#uid#.persos[j]['y_value'] + config#uid#.persos[j]['size_text'] + 2
                }
                config#uid#.persos[j]['isHistorized'] = cmd.isHistorized
                config#uid#.persos[j]['id'] = cmd.id
                config#uid#.persos[j]['value'] = persoValue
                config#uid#.persos[j]['unit'] = cmd.unite
                jeedom.cmd.addUpdateFunction(cmd.id, function(_options) {
                  if (is_object(cmd = document.getElementById("perso" + num + "-value-#uid#"))) {
                    let innerHTML = ''
                    if (config#uid#.persos[num]['position'] == 'inline') {
                      innerHTML += (config#uid#.persos[num]['text']) ? config#uid#.persos[num]['text'] + ' ' : ''
                    }
                    innerHTML += (is_numeric(_options.value) ? formatMillier(_options.value, config#uid#.formatMillier) : _options.value) + ' ' + config#uid#.persos[num]['unit']
                    cmd.innerHTML = innerHTML
                  }
                })
              }
            })
          }
        })
      }
    }
    if (debug#uid#) console.table(config#uid#)
    log#uid#('└──────────────────────────────────────────────────────')
    
    init#uid#(true)
    
    function init#uid#(init=true,el='') {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [init()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#");
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {
        if (el != '') log#uid#('| | launched by ' + el)
        if (init) {
          if (config#uid#.solar.mppts > 6) config#uid#.load.force4load = false
          let nb_load = config#uid#.load.additional_loads
          if (numIsPair(nb_load) && nb_load >= 1) nb_load = nb_load - 1
          let nb_solar = config#uid#.solar.mppts
          if (numIsPair(nb_solar) && nb_solar >= 1) nb_solar = nb_solar - 1
          
          let max_load = (482 + 76 + Math.floor(nb_load / 2) * 76) // défaut 2 par colonnes
          if (!config#uid#.has_load) max_load = 290 // OK
          else if (config#uid#.load.additional_loads == 0) max_load = 482 // OK
          else if (config#uid#.solar.mppts <= 6 && config#uid#.load.force4load) max_load = (482 + 76 + Math.trunc(nb_load / 4.1) * 76) // pour 4 par colonnes
          
          let max_solar = (406 + Math.floor(nb_solar / 2) * 79) // défaut pour 7pv ou plus
          if (!config#uid#.has_solar || config#uid#.solar.mppts == 0 || config#uid#.solar.mppts == 1) {
            if (config#uid#.solar.daily.show) max_solar = 320 // OK
            else max_solar = 290 // OK
            
          }
          else if (config#uid#.solar.mppts == 2 || config#uid#.solar.mppts == 3) max_solar = 334
          else if (config#uid#.solar.mppts == 4 || config#uid#.solar.mppts == 5) max_solar = 410
          else if (config#uid#.solar.mppts == 6) max_solar = 486
          
          var html = '<div class="container#uid# card#uid#">'
          let viewBox_x = 0
          let viewBox_y = -90 // pv >= 7
          let viewBox_w = Math.max(max_load, max_solar)
          let viewBox_h = 300
          
          // début gauche
          //viewBox_x = 0
          
          /* test de resize gauche */
          viewBox_x = 1000
          if (config#uid#.has_aux && config#uid#.has_battery) {
            if (config#uid#.battery.daily.show_charge || config#uid#.battery.daily.show_discharge) viewBox_x = Math.min(viewBox_x, 0)
            else viewBox_x = Math.min(viewBox_x, 80)
          }
          
          if (!config#uid#.grid.has_grid_power) {
            if (!config#uid#.has_grid) viewBox_x = Math.min(viewBox_x, 190)
            else viewBox_x = Math.min(viewBox_x, 100)
          } else viewBox_x = Math.min(viewBox_x, 0)
          
          if (config#uid#.has_battery) {
            if (config#uid#.battery.daily.show_charge || config#uid#.battery.daily.show_discharge) viewBox_x = Math.min(viewBox_x, 100)
            else viewBox_x = Math.min(viewBox_x, 180)
          }
          if (config#uid#.has_aux) {
            if (config#uid#.aux.daily.show) viewBox_x = Math.min(viewBox_x, 100)
            else viewBox_x = Math.min(viewBox_x, 190)
            
          }
          if (config#uid#.has_solar) {
            if (config#uid#.solar.daily.show) viewBox_x = Math.min(viewBox_x, 160)
            else viewBox_x = Math.min(viewBox_x, 190)
            if (config#uid#.solar.mppts == 2) viewBox_x = Math.min(viewBox_x, 140)
            else if (config#uid#.solar.mppts == 3 || config#uid#.solar.mppts == 4) viewBox_x = Math.min(viewBox_x, 60)
            else if (config#uid#.solar.mppts == 5 || config#uid#.solar.mppts == 6) viewBox_x = Math.min(viewBox_x, 0)
          }
          
          // début haut
          if (!config#uid#.has_solar) {
            if (config#uid#.load.force4load) {
              if (config#uid#.load.additional_loads == 0) viewBox_y = 150
              else if (config#uid#.load.additional_loads == 1 || config#uid#.load.additional_loads == 2) viewBox_y = 130
              else if (config#uid#.load.additional_loads >= 3) viewBox_y = 20
            } 
            else if (config#uid#.load.additional_loads >= 1) viewBox_y = 110
            else viewBox_y = 150
          } else {
            if (config#uid#.load.force4load) {
              if (config#uid#.solar.mppts == 0 || config#uid#.solar.mppts == 1) viewBox_y = 60
              else viewBox_y = 0
              if (config#uid#.load.additional_loads >= 3) viewBox_y = Math.min(40, viewBox_y)
            } else {
              if (config#uid#.solar.mppts <= 1) viewBox_y = 60
              else if (config#uid#.solar.mppts >= 2 && config#uid#.solar.mppts <= 6) viewBox_y = 0
              else viewBox_y = -90
            }
          }
          
          // fin droite
          if (config#uid#.has_aux && config#uid#.has_battery) viewBox_w = Math.max(viewBox_w, 486)
          else if (config#uid#.has_battery) viewBox_w = Math.max(viewBox_w, 400)
          viewBox_w = viewBox_w - viewBox_x
          
          // fin bas
          if (config#uid#.has_solar === false) {
            if (config#uid#.load.force4load) {
              if (config#uid#.load.additional_loads == 0) viewBox_h = 300 - viewBox_y
              else if (config#uid#.load.additional_loads == 1) viewBox_h = 310 - viewBox_y
              else if (config#uid#.load.additional_loads == 2)  viewBox_h = 340 - viewBox_y
              else if (config#uid#.load.additional_loads == 3)  viewBox_h = 340 - viewBox_y
              else if (config#uid#.load.additional_loads > 3)  viewBox_h = 430 - viewBox_y
            } else {
              if (config#uid#.load.additional_loads == 0) viewBox_h = 310 - viewBox_y
              else if (config#uid#.load.additional_loads == 1) viewBox_h = 310 - viewBox_y
              else if (config#uid#.load.additional_loads > 1) viewBox_h = 350 - viewBox_y
            }
          } else {
            if (config#uid#.load.force4load) {
              if (config#uid#.load.additional_loads == 0 || config#uid#.load.additional_loads == 1) viewBox_h = 310 - viewBox_y
              else if (config#uid#.load.additional_loads == 2 || config#uid#.load.additional_loads == 3) viewBox_h = 320 - viewBox_y
              else viewBox_h = 415 - viewBox_y
            } else {
              if (config#uid#.load.additional_loads <= 1) viewBox_h = 310 - viewBox_y
              else viewBox_h = 350 - viewBox_y
            }
          }
          if (config#uid#.has_aux || config#uid#.has_battery) viewBox_h = Math.max(viewBox_h, (415 - viewBox_y))
          
          html += '<svg viewBox="' + viewBox_x + ' ' + viewBox_y + ' ' + viewBox_w + ' ' + viewBox_h + '" preserveAspectRatio="xMidYMid meet" height="100%" width="100%" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" style="' + ((debug#uid#) ? 'border: 1px red dashed;' : '') + '">'
          
          
          ///////////////////////////////////////////////////////
          ///////////////////// SOLAR ///////////////////////////
          ///////////////////////////////////////////////////////
          html += '<!-- PV -->'
          if (config#uid#.has_solar) {
            html += '<rect id="pv-rect-#uid#"x="205" y="128.5" width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke="var(--solar_colour#uid#)" pointer-events="all" class="' + ((config#uid#.solar.mppts == 1) ? 'hidden-#uid#' : '') + '"/>'
            if (config#uid#.activateGauge)
              html += '<rect id="pv-rect-gauge-#uid#" class="op-#uid#' + ((config#uid#.solar.mppts == 1) ? ' hidden-#uid#' : '') + '" x="205" y="128.5" width="0" height="30" rx="4.5" ry="4.5" fill="var(--solar_colour#uid#)" stroke="none" pointer-events="all"/>'
            ///  SOLAR POWER  \\\
            html += '<text id="pv-power-#uid#" fill="var(--solar_colour#uid#)" x="238.8" y="148" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid# '
            html += (config#uid#.solar.has_pv_power && config#uid#.solar.isHistorized == 1) ? 'history cursor' : '' 
            html += '" display="' + ((config#uid#.solar.mppts == 1) ? 'none' : '') + '"'
            html += (config#uid#.solar.has_pv_power && config#uid#.solar.isHistorized == 1) ? ' data-cmd_id=' + config#uid#.solar.id : ''
            html += '>'
            if (config#uid#.autoConversionUnit) {
              let power = autoValueArray#uid#(config#uid#.solar.power, config#uid#.solar.power_unit)
              let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
            } else {
              let PowerAbs = trunc#uid#(Math.abs(config#uid#.solar.power), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.solar.power_unit
            }
            html += '</text>'
            ///  SOLAR LINE  \\\
            if (config#uid#.solar.mppts > 6) {
              html += '<path id="pv-line-2-#uid#" d="M 239 128 L 239 58" fill="none" stroke="var(--solar_colour#uid#)" stroke-width="1" stroke-miterlimit="10"  pointer-events="stroke"/>'
              html += '<circle id="pv-dot-2-#uid#" cx="0" cy="0" r="3" fill="transparent">'
              html += '<animateMotion id="pv-anim-2-#uid#" dur="' + config#uid#.solar.animation_speed + 's" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear">'
              html += '<mpath xlink:href="#pv-line-2-#uid#"/></animateMotion></circle>'
            }
            html += '<path id="pv-line-1-#uid#" d="M 239 196 L 239 158" fill="none" stroke="var(--solar_colour#uid#)" stroke-width="1" stroke-miterlimit="10"  pointer-events="stroke"/>'
            html += '<circle id="pv-dot-1-#uid#" cx="0" cy="0" r="3" fill="transparent">'
            html += '<animateMotion id="pv-anim-1-#uid#" dur="' + config#uid#.solar.animation_speed + 's" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear">'
            html += '<mpath xlink:href="#pv-line-1-#uid#"/></animateMotion></circle>'
            ///  SOLAR ICON  \\\
            html += '<svg id="pv-icon-#uid#" xmlns="http://www.w3.org/2000/svg" x="'
            html += config#uid#.solar.daily.show === false ? '220' : (config#uid#.solar.mppts > 6 ? '205' : '180')
            html += '" y="'
            html += (config#uid#.solar.mppts == 0 || config#uid#.solar.mppts == 1) ? '70' : (config#uid#.solar.mppts > 6 ? '-13' : '10')
            html += '" width="' + ((config#uid#.solar.mppts > 6) ? '70' : '40') + '" height="' + ((config#uid#.solar.mppts > 6) ? '70' : '40') + '" viewBox="0 0 24 24">'
            html += '<path fill="var(--solar_colour#uid#)" d="M11.45 2v3.55L15 3.77L11.45 2m-1 6L8 10.46l3.75 1.25L10.45 8M2 11.45L3.77 15l1.78-3.55H2M10 2H2v8c.57.17 1.17.25 1.77.25c3.58.01 6.49-2.9 6.5-6.5c-.01-.59-.1-1.18-.27-1.75m7 20v-6h-3l5-9v6h3l-5 9Z"/></svg>'
            ///  SOLAR DAILY  ///
            if (config#uid#.solar.daily.show) {
              html += '<text id="pv-daily-#uid#" fill="var(--solar_colour#uid#)" x="226" y="'
              html += (config#uid#.solar.mppts == 0 || config#uid#.solar.mppts == 1) ? '85' : (config#uid#.solar.mppts > 6 ? '-60' : '26')
              html += '" class="ft16-#uid# left-align#uid# ' + ((config#uid#.solar.daily.isHistorized == 1) ? 'history cursor' : '') + '"'
              html += (config#uid#.solar.daily.isHistorized == 1) ? ' data-cmd_id=' + config#uid#.solar.daily.id : ''
              html += '>'
              if (config#uid#.autoConversionUnit) {
                let dailySolar = autoValueArray#uid#(config#uid#.solar.daily.state, config#uid#.solar.daily.unit)
                let dailySolarAbs = trunc#uid#(Math.abs(dailySolar.value), config#uid#.powerTrunc)
                html += formatMillier(dailySolarAbs, config#uid#.formatMillier) + ' ' + dailySolar.unit
              } else {
                let dailySolarAbs = trunc#uid#(Math.abs(config#uid#.solar.daily.state), config#uid#.powerTrunc)
                html += formatMillier(dailySolarAbs, config#uid#.formatMillier) + ' ' + config#uid#.solar.daily.unit
              }
                html += '</text>'
              
              html += '<text fill="var(--solar_colour#uid#)" class="ft9-#uid# left-align#uid#" x="226" y="'
              html += (config#uid#.solar.mppts == 0 || config#uid#.solar.mppts == 1) ? '100' : (config#uid#.solar.mppts > 6 ? '-46' : '40')
              html += '">' + config#uid#.solar.daily.text + '</text>'
            }
          }
          ///////////////////////////////////////////////////////
          ///////////////////// SOLARs //////////////////////////
          ///////////////////////////////////////////////////////
          for (solar in config#uid#.solars) {
            ////////////////////////////////////
            //  variables for 7 mpps or more  //
            ////////////////////////////////////
            let paire_solar = parseInt(solar)
            let pas_horizontal = 79
            let x_rect = 0
            let y_rect = -60
            let x_power = 0
            let y_power = (config#uid#.solars[solar].energy !== false) ? -45.5 : -40
            let a_solar = 0
            let b_solar = '-30'
            let c_solar = '-8.5'
            let d_solar = '1.5'
            let x_name = 0
            let y_name = -66
            let x_energy = 0
            let y_energy = -34.5
            let x_voltage = 0
            let y_voltage = -5
            let x_current = 0
            let y_current = -15
            let r_path = 8 // rayon courbes lines
            if (numIsPair(solar)) {
              paire_solar = paire_solar - 1
              y_rect = 61
              b_solar = '61'
              c_solar = '43.5'
              d_solar = '29.5'
              y_name = 104
              y_power = (config#uid#.solars[solar].energy !== false) ? 75.5 : 81
              y_energy = 86.5
              y_voltage = 53
              y_current = 43
            }
            paire_solar = Math.floor(paire_solar / 2)
            x_rect = 327 + paire_solar * pas_horizontal
            x_power = 362 + paire_solar * pas_horizontal
            x_energy = 362 + paire_solar * pas_horizontal
            x_name = 362 + paire_solar * pas_horizontal
            a_solar = 362 + paire_solar * pas_horizontal
            
            x_voltage = x_rect + 35 - 5
            x_current = x_rect + 35 - 5
            if (config#uid#.solars[solar].current === false) y_voltage = y_voltage - 10
            let path_solar = 'M ' + a_solar + ' ' + b_solar + ' L ' + a_solar + ' ' + c_solar + ' Q ' + a_solar + ' ' + d_solar + ' ' + (a_solar - 10) + ' ' + d_solar + ' L 275 ' + d_solar
            ////////////////////////////////////
            // variables for 6 mppts or less  //
            ////////////////////////////////////
            if (config#uid#.solar.mppts <= 6) {
              y_rect = (config#uid#.solar.mppts == 1) ? 128.5 : 64.5
              y_name = (config#uid#.solar.mppts == 1) ? 122 : 60
              y_power = (config#uid#.solar.mppts == 1) ? ((config#uid#.solars[solar].energy === false) ? 148 : 143) : ((config#uid#.solars[solar].energy === false) ? 84 : 79)
              y_energy = (config#uid#.solar.mppts == 1) ? 154 : 90
              y_voltage = (config#uid#.solar.mppts == 1) ? ((config#uid#.solars[solar].current === false) ? '172' : '184') : ((config#uid#.solars[solar].current === false) ? '106' : '118')
              y_current = (config#uid#.solar.mppts == 1) ? 172 : 106
              if (config#uid#.solars[solar].energy === false) y_power + 5
              if (solar == 1) {
                x_rect = (config#uid#.solar.mppts == 1) ? 205 : 156 //154
                path_solar = 'M 191 95 L 191 135 Q 191 143 199 144 L 205 144'
                //path_solar = 'M ' + (x_rect + 35) + ' 95 L ' + (x_rect + 35) + ' 132 Q ' + (x_rect + 35) + ' 143 195 144 L 205 143'
              } else if (solar == 2) {
                x_rect = 254
                x_voltage = x_current = x_rect + 30
                path_solar = 'M 289 95 L 289 135 Q 289 143 281 144 L 275 144'
              } else if (solar == 3) {
                x_rect = 80
                path_solar = 'M 115 95 L 115 135 Q 115 143 123 144 L 205 144'
              } else if (solar == 4) {
                x_rect = 330
                path_solar = 'M 365 95 L 365 135 Q 365 143 357 144 L 275 144'
              } else if (solar == 5) {
                x_rect = 2
                path_solar = 'M 37 95 L 37 135 Q 37 143 45 144 L 205 144'
              } else if (solar == 6) {
                x_rect = 406
                path_solar = 'M 441 95 L 441 135 Q 441 143 433 144 L 275 144'
              }
              x_power = x_rect + 35
              x_energy = x_rect + 35
              x_name = x_rect + 35
              x_voltage = x_current = x_rect + 35 - 5
              a_solar = x_rect + 35
              //path_solar = 'M 365 95 L 365 135 Q 365 144 358 144 L 275 144'
            }
            ////////////////////////////////////
            /////         DISPLAY          /////
            ////////////////////////////////////
            html += '<!-- PV ' + solar + ' -->'
            html += '<rect id="pv' + solar + '-rect-#uid#" x="' + x_rect + '" y="' + y_rect + '" width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke="'
            html += (config#uid#.solars[solar].max_alert && config#uid#.solars[solar].power >= config#uid#.solars[solar].max_alert) ? 'var(--color_alerte#uid#)' : (config#uid#.solars[solar].power == 0) ? 'var(--solar_colour-0-#uid#)' : 'var(--solar_colour#uid#)'
            html += '" class="'
            html += (config#uid#.blink && config#uid#.solars[solar].max_alert && config#uid#.solars[solar].power >= config#uid#.solars[solar].max_alert) ? 'blink#uid#' : ''
            html += '"/>'
            if (config#uid#.solars[solar].max_power && config#uid#.activateGauge) {
              let gaugePourcent = config#uid#.solars[solar].power * 100 / config#uid#.solars[solar].max_power
              let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
              html += '<rect id="pv' + solar + '-rect-gauge-#uid#" class="op-#uid# '
              html += (config#uid#.blink && config#uid#.solars[solar].max_alert && config#uid#.solars[solar].power >= config#uid#.solars[solar].max_alert) ? 'blink#uid#' : ''
              html += '" x="' + x_rect + '" y="' + y_rect + '" width="' + width_rect_gauge + '" height="30" rx="4.5" ry="4.5" fill="var(--solar_colour#uid#)" stroke="none" />'
            }
            ///////////////
            ///  POWER  ///
            ///////////////
            html += '<text id="pv' + solar + '-power-#uid#" fill="'
            html += (config#uid#.solars[solar].max_alert && config#uid#.solars[solar].power >= config#uid#.solars[solar].max_alert && config#uid#.font_alert) ? 'var(--color_alerte#uid#)' : (config#uid#.solars[solar].power == 0) ? 'var(--solar_colour-0-#uid#)' : 'var(--solar_colour#uid#)'
            html += '" x="' + x_power + '" y="' + y_power + '" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid# '
            html += (isset(config#uid#.solars[solar]) && isset(config#uid#.solars[solar].power_isHistorized) && config#uid#.solars[solar].power_isHistorized == 1) ? 'history cursor' : ''
            html += '"'
            html += (isset(config#uid#.solars[solar]) && isset(config#uid#.solars[solar].power_id)) ? ' data-cmd_id=' + config#uid#.solars[solar].power_id : ''
            html += '>'
            if (config#uid#.autoConversionUnit) {
              let power = autoValueArray#uid#(config#uid#.solars[solar].power, config#uid#.solars[solar].power_unit || '')
              let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
            } else {
              let PowerAbs = trunc#uid#(Math.abs(config#uid#.solars[solar].power), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.solars[solar].power_unit || ''
            }
            html += '</text>'
            ///  PV LINE  \\\
            if (config#uid#.solar.mppts > 1) {
              html += '<path id="pv' + solar + '-line-#uid#" d="' + path_solar + '" fill="none" stroke="'
              html += (config#uid#.solars[solar].power == 0) ? 'var(--solar_colour-0-#uid#)' : 'var(--solar_colour#uid#)'
              html += '" stroke-width="1" stroke-miterlimit="10"  pointer-events="stroke" />'
              html += '<circle id="pv' + solar + '-dot-#uid#" cx="0" cy="0" r="3" fill="' + ((config#uid#.solars[solar].power == 0) ? 'transparent' : 'var(--solar_colour#uid#)') + '">'
              html += '<animateMotion id="pv' + solar + '-anim-#uid#" dur="3s" repeatCount="indefinite" keyPoints="0;1" keyTimes="0;1" calcMode="linear">'//' + config#uid#.solar.animation_speed + '
              html += '<mpath xlink:href="#pv' + solar + '-line-#uid#"/></animateMotion></circle>'
            }
            ///  PV DAILY  \\\
            if (config#uid#.solars[solar].energy !== false) {
              html += '<text id="pv' + solar + '-daily-#uid#" fill="'
              html += (config#uid#.solars[solar].power == 0) ? 'var(--solar_colour-0-#uid#)' : 'var(--solar_colour#uid#)'
              html += '" x="' + x_energy + '" y="' + y_energy + '" class="ft8-#uid# center-align#uid# sh-#uid# ' + ((config#uid#.solars[solar].energy_isHistorized == 1) ? 'history cursor' : '') + '"'
              html += ((config#uid#.solars[solar].energy_isHistorized == 1 && config#uid#.solars[solar].energy_id) ? ' data-cmd_id=' + config#uid#.solars[solar].energy_id : '')
              html += '>'
              if (config#uid#.autoConversionUnit) {
                let energy = autoValueArray#uid#((config#uid#.solars[solar].energy || 0),config#uid#.solars[solar].energy_unit || '')
                let energyAbs = trunc#uid#(Math.abs(energy.value), config#uid#.powerTrunc)
                html += formatMillier(energyAbs, config#uid#.formatMillier) + ' ' + energy.unit + '</text>'
              } else {
                let energyAbs = trunc#uid#(Math.abs(config#uid#.solars[solar].energy || 0), config#uid#.powerTrunc)
                html += formatMillier(energyAbs, config#uid#.formatMillier) + ' ' + config#uid#.solars[solar].energy_unit || '' + '</text>'
              }
              html += '</text>'
            }
            ///  PV VOLTAGE  \\\
            if (config#uid#.solars[solar].voltage !== false) {
              html += '<text id="pv' + solar + '-voltage-#uid#" fill="'
              html += (config#uid#.solars[solar].power == 0) ? 'var(--solar_colour-0-#uid#)' : 'var(--solar_colour#uid#)'
              html += '" x="' + x_voltage + '" y="'+ y_voltage + '" class="ft9-#uid# right-align#uid# ' + ((config#uid#.solars[solar].voltage_isHistorized == 1) ? 'history cursor' : '') + '"'
              html += ((config#uid#.solars[solar].voltage_isHistorized == 1 && config#uid#.solars[solar].voltage_id) ? ' data-cmd_id=' + config#uid#.solars[solar].voltage_id : '')
              html += '>' + trunc#uid#(config#uid#.solars[solar].voltage, config#uid#.powerTrunc) + ' ' + config#uid#.solars[solar].voltage_unit + '</text>'
            }
            ///  PV CURRENT  \\\
            if (config#uid#.solars[solar].current !== false) {
              html += '<text id="pv' + solar + '-current-#uid#" fill="'
              html += (config#uid#.solars[solar].power == 0) ? 'var(--solar_colour-0-#uid#)' : 'var(--solar_colour#uid#)'
              html += '" x="' + x_current + '" y="' + y_current + '" class="ft9-#uid# right-align#uid# ' + ((config#uid#.solars[solar].current_isHistorized == 1) ? 'history cursor' : '') + '"'
              html += ((config#uid#.solars[solar].current_isHistorized == 1 && config#uid#.solars[solar].current_id) ? ' data-cmd_id=' + config#uid#.solars[solar].current_id : '')
              html += '>' + trunc#uid#(config#uid#.solars[solar].current, config#uid#.powerTrunc) + ' ' + config#uid#.solars[solar].current_unit + '</text>'
            }
            ///  PV NAME  \\\
            if (config#uid#.solars[solar].name !== false) {
              html += '<text id="pv' + solar + '-name-#uid#" fill="'
              html += (config#uid#.solars[solar].power == 0) ? 'var(--solar_colour-0-#uid#)' : 'var(--solar_colour#uid#)'
              html += '" x="' + x_name + '" y="' + y_name + '" class="ft9-#uid# ftw-#uid# center-align#uid#" display="' + ((config#uid#.has_solar === false) ? 'none' : '') + '">' + config#uid#.solars[solar].name + '</text>'
            }
          }
          ///////////////////////////////////////////////////////
          ///////////////////// PERSOS //////////////////////////
          ///////////////////////////////////////////////////////
          html += '<!-- PERSOS -->'
          for (perso in config#uid#.persos) {
            html += '<text id="perso' + perso + '-value-#uid#" fill="' + config#uid#.persos[perso].color + '" '
            html += 'x="' + config#uid#.persos[perso].x_value + '" y="' + config#uid#.persos[perso].y_value + '"'
            html += ' class="ft' + config#uid#.persos[perso].size_value + '-#uid# left-align#uid# '
            html += (config#uid#.persos[perso].isHistorized == 1) ? 'history cursor' : ''
            html += '"'
            html += (config#uid#.persos[perso].isHistorized == 1) ? ' data-cmd_id=' + config#uid#.persos[perso].id : ''
            html += '>'
            
if (config#uid#.persos[perso].text != '' && config#uid#.persos[perso].position == 'inline') {
  html += config#uid#.persos[perso].text + ' '
}
              
            html += (is_numeric(config#uid#.persos[perso].value) ? formatMillier(config#uid#.persos[perso].value, config#uid#.formatMillier) : config#uid#.persos[perso].value)
            if (config#uid#.persos[perso].unit != '') html += ' ' + config#uid#.persos[perso].unit
            html += '</text>'
            if (config#uid#.persos[perso].text != '' && config#uid#.persos[perso].position != 'inline') {
              html += '<text id="perso' + perso + '-text-#uid#" x="' + config#uid#.persos[perso].x_value + '" y="' + config#uid#.persos[perso].y_text + '" class="ft' + config#uid#.persos[perso].size_text + '-#uid# left-align#uid#" fill="' + config#uid#.persos[perso].color + '">' + config#uid#.persos[perso].text + '</text>'
            }
          }
          ///////////////////////////////////////////////////////
          ////////////////////// LOAD ///////////////////////////
          ///////////////////////////////////////////////////////
          if (config#uid#.has_load) {
            html += '<!-- Load -->'
            html += '<rect id="load-rect-#uid#" x="304" y="213" width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke="var(--load_colour#uid#)"/>'
            ///////////////
            ///  GAUGE  ///
            ///////////////
            if (config#uid#.activateGauge) {
              html += '<rect id="load-rect-gauge-#uid#" class="op-#uid#" x="304" y="213" width="0" height="30" rx="4.5" ry="4.5" fill="var(--load_colour#uid#)" stroke="none"/>'
            }
            ///////////////
            ///  LINE   ///
            ///////////////
            html += '<path id="load-line1-#uid#" d="M 304 228 L 264.7 228" fill="none" stroke="var(--load_colour#uid#)" stroke-width="1" stroke-miterlimit="10"/>'
            html += '<circle id="load-dot1-#uid#" cx="0" cy="0" r="3" fill="transparent">'
            html += '<animateMotion id="load-anim1-#uid#" dur="' + config#uid#.load.animation_speed + 's" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear">'
            html += '<mpath xlink:href="#load-line1-#uid#"/></animateMotion></circle>'
            html += '<path id="load-line2-#uid#" d="M 374 228 L 402.38 228" fill="none" stroke="var(--load_colour#uid#)" stroke-width="1" stroke-miterlimit="10"/>'
            html += '<circle id="load-dot2-#uid#" cx="0" cy="0" r="3" fill="transparent"><animateMotion id="load-anim2-#uid#" dur="' + config#uid#.load.animation_speed + 's" repeatCount="indefinite" keyPoints="0;1" keyTimes="0;1" calcMode="linear"><mpath xlink:href="#load-line2-#uid#"/></animateMotion></circle>'
            ///////////////
            ///  ICON   ///
            ///////////////
            html += '<svg id="load-icon-#uid#" fill="var(--load_colour#uid#)" x="400" y="185" width="80" height="80" style="color:var(--load_colour#uid#)"><use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-load"></use></svg>'
            /////////////////////
            ///  GAUGE RATIO  ///
            /////////////////////
            if (config#uid#.activateGaugeRatio) {
              html += '<rect id="rate-solar-#uid#" x="304" y="213" width="70" height="30" rx="4.5" ry="4.5" class="circle#uid#" fill="none" stroke="var(--solar_colour#uid#)" pointer-events="all" shape-rendering="geometricPrecision"/>'
              html += '<rect id="rate-battery-#uid#" x="304" y="213" width="70" height="30" rx="4.5" ry="4.5" class="circle#uid#" fill="none" stroke="var(--battery-discharge#uid#)" pointer-events="all" shape-rendering="geometricPrecision"/>'
              html += '<rect id="rate-aux-#uid#" x="304" y="213" width="70" height="30" rx="4.5" ry="4.5" class="circle#uid#" fill="none" stroke="var(--aux_colour#uid#)" pointer-events="all" shape-rendering="geometricPrecision"/>'
              html += '<rect id="rate-grid-#uid#" x="304" y="213" width="70" height="30" rx="4.5" ry="4.5" class="circle#uid#" fill="none" stroke="var(--grid-buy-colour#uid#)" pointer-events="all" shape-rendering="geometricPrecision"/>'
              html += '<rect id="rate-unknown-#uid#" x="304" y="213" width="70" height="30" rx="4.5" ry="4.5" class="circle#uid#" fill="none" stroke="var(--color_alerte#uid#)" pointer-events="all" shape-rendering="geometricPrecision"/>'
            }
            ///////////////
            ///  POWER  ///
            ///////////////
            html += '<text id="load-power-#uid#" x="338.1" y="232.2" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid# ' + ((config#uid#.load.isHistorized == 1) ? 'history cursor' : '') + '" fill="var(--load_colour#uid#)"'
            html += ((config#uid#.load.isHistorized == 1) ? ' data-cmd_id=' + config#uid#.load.id : '')
            html += '>'
            if (config#uid#.autoConversionUnit) {
              let power = autoValueArray#uid#(config#uid#.load.power, config#uid#.load.power_unit)
              let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
            } else {
              let PowerAbs = trunc#uid#(Math.abs(config#uid#.load.power), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.load.power_unit
            }
            html += '</text>'
            ///////////////
            ///  DAILY  ///
            ///////////////
            if (config#uid#.load.daily.show) {
              html += '<text id="load-daily-#uid#" x="304" y="178" class="ft16-#uid# left-align#uid# ' + ((config#uid#.load.daily.isHistorized == 1) ? 'history cursor' : '') + '" fill="var(--load_colour#uid#)"'
              html += ((config#uid#.load.daily.isHistorized == 1) ? ' data-cmd_id=' + config#uid#.load.daily.id : '')
              html += '>'
              if (config#uid#.autoConversionUnit) {
                let dailyLoad = autoValueArray#uid#(config#uid#.load.daily.state, config#uid#.load.daily.unit)
                let dailyAbs = trunc#uid#(Math.abs(dailyLoad.value), config#uid#.powerTrunc)
                html += formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + dailyLoad.unit
              } else {
                let dailyAbs = trunc#uid#(Math.abs(config#uid#.load.daily.state), config#uid#.powerTrunc)
                html += formatMillier(dailyAbs, config#uid#.formatMillier) + ' ' + config#uid#.load.daily.unit
              }
              html += '</text>'
              html += '<text x="304" y="192.2" class="ft9-#uid# left-align#uid#" fill="var(--load_colour#uid#)" >' + config#uid#.load.daily.text + '</text>'
            }

            ///////////////////////////////////////////////////////
            ///////////////////// LOADS ///////////////////////////
            ///////////////////////////////////////////////////////
            /* test */
            var max_width_load = 0
            for (load in config#uid#.loads) {
              ////////////////////////////////////
              //            variables           //
              ////////////////////////////////////
              let num_load = parseInt(load)
              let pas_horizontal = 76
              let nbre_colonnes = 0
              let path = ''
              let x_rect = 482 //406
              let y_rect = 0
              let x_path = x_rect + 35
              let y_path = 0
              let y2_path = 228
              let x_power = x_rect + 35
              let y_power = 0
              let x_energy = x_rect + 35
              let y_energy = 0
              let x_name = x_rect + 35
              let y_name = 0
              let x_perso = x_rect + 30
              let y_perso = 0
              let x_icon = x_rect + 5 //x_rect + (70 / 2) + 2
              let y_icon = 0
            
              let a_path = x_rect + 35
              let b_path = 0
              let r_path = 8 // rayon courbes lines
              let c_path = 0
              let d_path = 0
              let e_path = 0
            
              if (config#uid#.solar.mppts <= 6 && config#uid#.load.force4load) {
                nbre_colonnes = Math.trunc(num_load / 4.1)
                if (numIsPair(num_load)) {
                  if (((nbre_colonnes * 4) + 4) == num_load) {
                    // D
                    y_rect = 272 + 92
                    y_path = y_rect
                    y2_path = y2_path + 92
                    y_name = y_rect + 30 + 10
                    y_perso = y_rect - 35 //5
                    y_icon = y_rect - 27
                  } else {
                    // C
                    y_rect = 272
                    y_path = y_rect
                    y_name = y_rect + 30 + 10
                    y_perso = y_rect - 34 //5
                    y_icon = y_rect - 27
                  }
                } else {
                  if (((nbre_colonnes * 4) + 3) == num_load) {
                    // A
                    y_rect = 156 - 92
                    y_path = y_rect + 30
                    y2_path = y2_path - 92
                    y_name = y_rect - 4
                    y_perso = y_rect + 70 //40
                    y_icon = y_rect + 32
                  } else {
                    // B
                    y_rect = 156
                    y_path = y_rect + 30
                    y_name = y_rect - 4
                    y_perso = y_rect + 67 //40
                    y_icon = y_rect + 32
                  }
                }
              } else {
                nbre_colonnes = Math.trunc(num_load / 2.1)
                if (numIsPair(num_load)) {
                  // C
                  y_rect = 297.5
                  y_path = y_rect
                  y_name = y_rect + 30 + 10
                  y_perso = y_rect - 45 //5
                  y_icon = y_rect - 27
                  b_path = 242
                  c_path = y_rect
                  d_path = b_path + r_path
                } else {
                  // B
                  y_rect = 156
                  y_rect = 128.5
                  y_path = y_rect + 30
                  y_name = y_rect - 6
                  y_perso = y_rect + 80 //40
                  y_icon = y_rect + 32
                  b_path = 214
                  c_path = y_rect + 30
                  d_path = b_path - r_path
                }
              }
              //y_power = (!isset(config#uid#.loads[load]) || config#uid#.loads[load].energy === false) ? y_rect + 20 : y_rect + 20 - 5
              y_power = (config#uid#.loads[num_load].energy === false) ? y_rect + 20 : y_rect + 20 - 5
              y_energy = y_rect + 25
            
              x_rect = x_rect + nbre_colonnes * pas_horizontal
              x_path = x_path + nbre_colonnes * pas_horizontal
              
              max_width_load = Math.max(max_width_load, x_path)
              x_power = x_power + nbre_colonnes * pas_horizontal
              x_energy = x_energy + nbre_colonnes * pas_horizontal
              x_name = x_name + nbre_colonnes * pas_horizontal
              x_perso = x_perso + nbre_colonnes * pas_horizontal
              x_icon = x_icon + nbre_colonnes * pas_horizontal
            
              a_path = a_path + nbre_colonnes * pas_horizontal
              e_path = a_path - r_path
            
              if (config#uid#.solar.mppts <= 6 && config#uid#.load.force4load) path = 'M ' + x_path + ' ' + y_path + ' L ' + x_path + ' ' + y2_path
              else path = 'M ' + a_path + ' ' + c_path + ' L ' + a_path + ' ' + d_path + ' Q ' + a_path + ' ' + b_path + ' ' + e_path + ' ' + b_path + ' L 475 ' + b_path
            
              ////////////////////////////////////
              /////         DISPLAY          /////
              ////////////////////////////////////
              html += '<!-- Load ' + num_load + '-->'
              html += '<rect id="load' + num_load + '-rect-#uid#" class="'
              html += ((config#uid#.blink && config#uid#.loads[num_load].max_power && config#uid#.loads[num_load].power >= config#uid#.loads[num_load].max_power) ? 'blink#uid#' : '')
              html += '" x="' + x_rect + '" y="' + y_rect + '" width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke="'
              html += ((config#uid#.loads[num_load].max_power && config#uid#.loads[num_load].power >= config#uid#.loads[num_load].max_power) ? 'var(--color_alerte#uid#)' : 'var(--load_colour#uid#)')
              html += '" />'
              if (config#uid#.loads[num_load].max_power && config#uid#.activateGauge) {
                let gaugePourcent = config#uid#.loads[num_load].power * 100 / config#uid#.loads[num_load].max_power
                let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
                html += '<rect id="load' + num_load + '-rect-gauge-#uid#" class="op-#uid# '
                html += ((config#uid#.blink && config#uid#.loads[num_load].max_power && config#uid#.loads[num_load].power >= config#uid#.loads[num_load].max_power) ? 'blink#uid#' : '')
                html += '" x="' + x_rect + '" y="' + y_rect + '" width="' + width_rect_gauge + '" height="30" rx="4.5" ry="4.5" fill="var(--load_colour#uid#)" stroke="none" />'
              }
              
              ///////////////
              ///  POWER  ///
              ///////////////
              html += '<text id="load' + num_load + '-power-#uid#" x="' + x_power + '" y="' + y_power + '" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid#' + (isset(config#uid#.loads[num_load].power_isHistorized) && config#uid#.loads[num_load].power_isHistorized == 1 ? ' history cursor' : '')
              html += ((config#uid#.font_alert && config#uid#.blink && config#uid#.loads[num_load].max_power && config#uid#.loads[num_load].power >= config#uid#.loads[num_load].max_power) ? ' blink#uid#' : '')
              html += '" fill="'
              html += ((config#uid#.font_alert && config#uid#.loads[num_load].max_power && config#uid#.loads[num_load].power >= config#uid#.loads[num_load].max_power) ? 'var(--color_alerte#uid#)' : 'var(--load_colour#uid#)')
              html += '"'
              html += ((isset(config#uid#.loads[num_load].power_id) && config#uid#.loads[num_load].power_id) ? ' data-cmd_id=' + config#uid#.loads[num_load].power_id : '')
              html += '>'
              if (config#uid#.autoConversionUnit) {
                let power = autoValueArray#uid#(config#uid#.loads[num_load].power, config#uid#.loads[num_load].power_unit || '')
                let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
              } else {
                let PowerAbs = trunc#uid#(Math.abs(config#uid#.loads[num_load].power), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.loads[num_load].power_unit || ''
              }
              html += '</text>'
              ///////////////
              ///  LINE   ///
              ///////////////
              html += '<path id="load' + num_load + '-line-#uid#" d="' + path + '" fill="none" stroke="var(--load_colour#uid#)" stroke-width="1" stroke-miterlimit="10" />'
              html += '<circle id="load' + num_load + '-dot-#uid#" cx="0" cy="0" r="3"  class="' + ((config#uid#.load.animate_load_enable === true) ? '' : 'hidden-#uid#') + '" '
              html += 'fill="' + ((config#uid#.loads[load].power == 0) ? 'transparent' : 'var(--load_colour#uid#)') + '">'
              html += '<animateMotion id="anim_load' + num_load + '-#uid#" dur="3" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear">'
              html += '<mpath xlink:href="#load' + num_load + '-line-#uid#"></mpath></animateMotion></circle>'
              ///////////////
              ///  ENERGY ///
              ///////////////
              if (config#uid#.loads[num_load].energy !== false) {
                
                html += '<text id="load' + num_load + '-daily-#uid#" x="' + x_energy + '" y="' + y_energy + '" class="ft8-#uid# center-align#uid# sh-#uid# ' + (config#uid#.loads[num_load].energy_isHistorized == 1 ? 'history cursor' : '')
                html += '" fill="var(--load_colour#uid#)"'
                html += ((config#uid#.loads[num_load].energy_id) ? ' data-cmd_id=' + config#uid#.loads[num_load].energy_id : '')
                html += '>'
                if (config#uid#.autoConversionUnit) {
                  let load_energy = autoValueArray#uid#(config#uid#.loads[num_load].energy, config#uid#.loads[num_load].energy_unit)
                  let load_energyAbs = trunc#uid#(Math.abs(load_energy.value), config#uid#.powerTrunc)
                  html += formatMillier(load_energyAbs, config#uid#.formatMillier) + ' ' + load_energy.unit
                } else {
                  let load_energyAbs = trunc#uid#(Math.abs(config#uid#.loads[num_load].energy), config#uid#.powerTrunc)
                  html += formatMillier(load_energyAbs, config#uid#.formatMillier) + ' ' + config#uid#.loads[num_load].energy_unit
                }
                html += '</text>'
              }
              ///////////////
              ///  NAME   ///
              ///////////////
              if (config#uid#.loads[num_load].name !== false) {
                html += '<text id="load' + num_load + '-name-#uid#" x="' + x_name + '" y="' + y_name + '" class="ft9-#uid# center-align#uid#" fill="var(--load_colour#uid#)" >' + config#uid#.loads[num_load].name + '</text>'
              }
              ///////////////
              ///  PERSO  ///
              ///////////////
              if (config#uid#.loads[num_load].perso !== false) {
                html += '<text id="load' + num_load + '_perso#uid#" x="' + x_perso + '" y="' + y_perso + '" class="ft8-#uid# right-align#uid# ' + (config#uid#.loads[load].perso_isHistorized == 1 ? 'history cursor' : '')
                html += '" fill="var(--load_colour#uid#)"'
                html += ((config#uid#.loads[num_load].perso_id) ? ' data-cmd_id=' + config#uid#.loads[num_load].perso_id : '')
                html += '>'
                html += (is_numeric(config#uid#.loads[num_load].perso) ? formatMillier(trunc#uid#(config#uid#.loads[num_load].perso, config#uid#.powerTrunc), config#uid#.formatMillier) : config#uid#.loads[num_load].perso)
                html += ' ' + config#uid#.loads[num_load].perso_unit + '</text>'
              }
              ///////////////
              ///   ICON  ///
              ///////////////
              if (config#uid#.loads[num_load].icon !== false) {
                let icon = config#uid#.loads[num_load].icon.split(",")
                for(let i = 0; i < icon.length; i++) {
                  if (icon[i].indexOf(".") !== -1) {
                    html += '<svg xmlns="http://www.w3.org/2000/svg" x="' + (x_icon + i * 35) + '" y="' + y_icon + '" width="25" height="25" viewBox="0 0 25 25" opacity="1"><image xlink:href="' + icon[i].trim() + '" x="0" y="0" height="25" width="25"/></svg>'
                  } else {
                    html += '<svg fill="var(--load_colour#uid#)" x="' + (x_icon + i * 35) + '" y="' + y_icon + '" width="25" height="25" style="color:var(--load_colour#uid#)">'
                    html += '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-' + icon[i].trim() + '"/>'
                    html += '</svg>'
                  }
                  if (i == 1) break
                }
              }
            }
            ///////////////
            ///  LINE   ///
            ///////////////
            if (config#uid#.load.additional_loads >= 1 && (config#uid#.solar.mppts <= 6 && config#uid#.load.force4load)) {
              let path = 'M 480 228 L ' + max_width_load + ' 228'
              html += '<path id="load-line3-#uid#" d="' + path + '" fill="none" stroke="var(--load_colour#uid#)" stroke-width="1" stroke-miterlimit="10"/>'
              html += '<circle id="load-dot3-#uid#" cx="0" cy="0" r="3"  class="' + ((config#uid#.load.animate_load_enable === true) ? '' : 'hidden-#uid#') + '" fill="transparent"><animateMotion id="load-anim3-#uid#" dur="3" repeatCount="indefinite" keyPoints="0;1" keyTimes="0;1" calcMode="linear"><mpath xlink:href="#load-line3-#uid#"></mpath></animateMotion></circle>'
            }

          }
          ///////////////////////////////////////////////////////
          /////////////////////  Grid ///////////////////////////
          ///////////////////////////////////////////////////////
          if (config#uid#.has_grid) {
            html += '<!-- Grid -->'
            if (config#uid#.grid.has_grid_power) {
              html += '<rect id="grid-rect-#uid#" class="" x="103" y="213" width="70" height="29.5" rx="4.42" ry="4.42" fill="none" stroke="var(--grid_colour#uid#)" />'
              if (config#uid#.activateGauge)
                html += '<rect id="grid-rect-gauge-#uid#" class="op-#uid#" x="103" y="213" width="0" height="29.5" rx="4.42" ry="4.42" fill="var(' + ((config#uid#.grid.power < 0) ? '--grid-buy-colour#uid#' : '--grid-sell-colour#uid#') + ')" stroke="transparent"/>'
              ///////////////
              ///  POWER  ///
              ///////////////
              html += '<text id="grid-power-#uid#" x="138.1" y="232.2" fill="var(--grid_colour#uid#)" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid# '
              html += (config#uid#.grid.isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id=' + config#uid#.grid.id + '>'
              if (config#uid#.autoConversionUnit) {
                let power = autoValueArray#uid#(config#uid#.grid.power, config#uid#.grid.power_unit)
                let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
              } else {
                let PowerAbs = trunc#uid#(Math.abs(config#uid#.grid.power), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.grid.power_unit
              }
              html += '</text>'
            }
            ///////////////
            ///  LINE   ///
            ///////////////
            
            // LINE GRID TO RECT POWER
            if (config#uid#.grid.has_grid_power) {
              html += '<path id="grid-line-1-#uid#" d="M 103 228 L 64.5 228" fill="none" stroke="var(--grid_colour#uid#)" stroke-width="1" stroke-miterlimit="10"  pointer-events="stroke"/>'
              html += '<circle id="grid-dot-buy-1-#uid#" cx="0" cy="0" r="3" fill="transparent">'
              html += '<animateMotion id="anim_grid_buy1#uid#" dur="' + config#uid#.grid.animation_speed + 's" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear">'
              html += '<mpath xlink:href="#grid-line-1-#uid#"/></animateMotion></circle>'
              html += '<circle id="grid-dot-sell-1-#uid#" cx="0" cy="0" r="3" fill="transparent">'
              html += '<animateMotion id="anim_grid_sell1#uid#" dur="' + config#uid#.grid.animation_speed + 's" repeatCount="indefinite" keyPoints="0;1" keyTimes="0;1" calcMode="linear">'
              html += '<mpath xlink:href="#grid-line-1-#uid#"/></animateMotion></circle>'
            }
            // LINE RECT POWER TO INVERTER
            html += '<path id="grid-line-2-#uid#" d="M 173 228 L 214 228" fill="none" stroke="var(--grid_colour#uid#)" stroke-width="1" stroke-miterlimit="10"  pointer-events="stroke"/>'
            html += '<circle id="grid-dot-buy-2-#uid#" cx="0" cy="0" r="3" fill="transparent">'
            html += '<animateMotion id="anim_grid_buy#uid#" dur="' + config#uid#.grid.animation_speed + 's" repeatCount="indefinite" keyPoints="0;1" keyTimes="0;1" calcMode="linear">'
            html += '<mpath xlink:href="#grid-line-2-#uid#"/></animateMotion></circle>'
            html += '<circle id="grid-dot-sell-2-#uid#" cx="0" cy="0" r="3" fill="transparent">'
            html += '<animateMotion id="anim_grid_sell#uid#" dur="' + config#uid#.grid.animation_speed + 's" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear">'
            html += '<mpath xlink:href="#grid-line-2-#uid#"/></animateMotion></circle>'
            
            ///////////////
            ///  ICON   ///
            ///////////////
            // OFF
            html += '<svg id="grid-transmission-off-#uid#" x="'
            html += (config#uid#.grid.has_grid_power) ? 0 : 110
            html += '" y="197.5" width="62" height="62" style="color:var(--no_grid_colour#uid#)" class="'
            html += (config#uid#.grid.status === 1) ? 'hidden-#uid# ' : ''
            html += (config#uid#.grid.status === 0 && config#uid#.blink) ? 'blink#uid# ' : ''
            html += '">'
            html += '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-transmission-off"/>'
            html += '</svg>'
            // ON
            html += '<svg id="grid-transmission-on-#uid#" x="'
            html += (config#uid#.grid.has_grid_power) ? 0 : 110
            html += '" y="197.5" width="62" height="62" style="color:var(--grid_colour#uid#)" class="'
            html += (config#uid#.grid.status === 0) ? 'hidden-#uid#' : ''
            html += '">'
            html += '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-transmission-on"/>'
            html += '</svg>'
            ///////////////
            ///  DAILY  ///
            ///////////////
            if (config#uid#.grid.daily.show_buy) {
              ///  BUY VALUE  \\\
              html += '<text id="grid-daily-buy-#uid#" x="'
              html += (config#uid#.grid.has_grid_power) ? 5 : 115
              html += '" y="277.9" fill="var(--grid-buy-colour#uid#)" class="ft16-#uid# left-align#uid# '
              html += (config#uid#.grid.daily.buy_isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.grid.daily.buy_id + '">'
              if (config#uid#.autoConversionUnit) {
                let dailyGridBuy = autoValueArray#uid#(config#uid#.grid.daily.buy_state, config#uid#.grid.daily.buy_unit)
                let dailyGridBuyAbs = trunc#uid#(Math.abs(dailyGridBuy.value), config#uid#.powerTrunc)
                html += formatMillier(dailyGridBuyAbs, config#uid#.formatMillier) + ' ' + dailyGridBuy.unit
              } else {
                let dailyGridBuyAbs = trunc#uid#(Math.abs(config#uid#.grid.daily.buy_state), config#uid#.powerTrunc)
                html += formatMillier(dailyGridBuyAbs, config#uid#.formatMillier) + ' ' + config#uid#.grid.daily.buy_unit
              }
              html += '</text>'
              ///  BUY LABEL  \\\
              html += '<text x="'
              html += (config#uid#.grid.has_grid_power) ? 5 : 115
              html += '" y="292.1" class="ft9-#uid# left-align#uid#" fill="' + ((config#uid#.grid.daily.show_buy !== true) ? 'transparent' : 'var(--grid-buy-colour#uid#)') + '" >' + config#uid#.grid.daily.text_buy + '</text>'
            }
            if (config#uid#.grid.daily.show_sell) {
              ///  SELL VALUE  \\\
              html += '<text id="grid-daily-sell-#uid#" x="'
              html += (config#uid#.grid.has_grid_power) ? 5 : 115
              html += '" y="175" fill="var(--grid-sell-colour#uid#)" class="ft16-#uid# left-align#uid# '
              html += (config#uid#.grid.daily.sell_isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.grid.daily.sell_id + '">'
              if (config#uid#.autoConversionUnit) {
                let dailyGridSell = autoValueArray#uid#(config#uid#.grid.daily.sell_state, config#uid#.grid.daily.sell_unit)
                let dailyGridSellAbs = trunc#uid#(Math.abs(dailyGridSell.value), config#uid#.powerTrunc)
                html += formatMillier(dailyGridSellAbs, config#uid#.formatMillier) + ' ' + dailyGridSell.unit
              } else {
                let dailyGridSellAbs = trunc#uid#(Math.abs(config#uid#.grid.daily.sell_state), config#uid#.powerTrunc)
                html += formatMillier(dailyGridSellAbs, config#uid#.formatMillier) + ' ' + config#uid#.grid.daily.sell_unit
              }
              html += '</text>'
              ///  SELL LABEL  \\\
              html += '<text x="'
              html += (config#uid#.grid.has_grid_power) ? 5 : 115
              html += '" y="189" class="ft9-#uid# left-align#uid#" fill="' + ((config#uid#.grid.daily.show_sell !== true) ? 'transparent' : 'var(--grid-sell-colour#uid#)') + '" >' + config#uid#.grid.daily.text_sell + '</text>'
            }
            ///////////////
            ///  TEMPO  ///
            ///////////////
            html += '<text id="grid-tempo-today-text-#uid#" x="78" y="221" class="ft12-#uid# left-align#uid#" fill="transparent" display=""></text>'
            html += '<circle id="grid-tempo-today-circle-#uid#" cx="66" cy="217" r="6" fill="transparent"></circle>'
            html += '<text  id="grid-tempo-tomorrow-text-#uid#" x="75" y="241" class="ft7-#uid# left-align#uid#" fill="transparent" display="">Demain</text>'
            html += '<circle id="grid-tempo-tomorrow-circle-#uid#" cx="66" cy="238" r="6" fill="transparent"></circle>'          
          }
          ///////////////////////////////////////////////////////
          ////////////////////// Battery ////////////////////////
          ///////////////////////////////////////////////////////
          html += '<!-- Battery -->'
          if (config#uid#.has_battery) {
            if (config#uid#.battery.power.show) { // test
              html += '<rect id="battery-rect-#uid#" x="'
              html += (config#uid#.has_aux) ? '104' : '204'
              html += '" y="300" width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke="var(--battery_colour#uid#)" pointer-events="all"></rect>'
              ///////////////
              ///  GAUGE  ///
              ///////////////
              if (config#uid#.activateGauge)
                html += '<rect id="battery-rect-gauge-#uid#" fill="transparent" class="op-#uid#" x="' + ((config#uid#.has_aux) ? '104' : '204') + '" y="300" width="0" height="30" rx="4.5" ry="4.5" stroke="transparent"/>'
              ///////////////
              ///  POWER  ///
              ///////////////
              html += '<text id="battery-power-#uid#" fill="var(--battery_colour#uid#)" x="'
              html += (config#uid#.has_aux) ? '140' : '239'
              html += '" y="320" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid# '
              html += (config#uid#.battery.power.isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.power.id + '">'
              if (config#uid#.autoConversionUnit) {
                let power = autoValueArray#uid#(config#uid#.battery.power.state, config#uid#.battery.power.unit)
                let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
              } else {
                let PowerAbs = trunc#uid#(Math.abs(config#uid#.battery.power.state), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.power.unit
              }
              html += '</text>'
            }
            ///////////////
            /// CURRENT ///
            ///////////////
            if (config#uid#.battery.current.show) {
              html += '<text id="battery-current-#uid#" fill="var(--battery_colour#uid#)" x="'
              html += (config#uid#.has_aux) ? '133' : '232'
              //html += '" y="295" class="ft9-#uid# right-align#uid# ' //test2
              // test2
              html += '" y="'
              html += ((config#uid#.battery.power.show) ? 295 : 325)
              html += '" class="ft9-#uid# right-align#uid# '
              ///
              html += (config#uid#.battery.current.isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.current.id + '">'
              let batteryCurrent = trunc#uid#(config#uid#.battery.current.state, config#uid#.powerTrunc)
              html += batteryCurrent + ' ' + config#uid#.battery.current.unit + '</text>'
            }
            ///////////////
            /// VOLTAGE ///
            ///////////////
            if (config#uid#.battery.voltage.show) {
              html += '<text id="battery-voltage-#uid#" fill="var(--battery_colour#uid#)" x="'
              html += (config#uid#.has_aux) ? '133' : '232'
              html += '" y="'
              //html += (config#uid#.battery.current.show) ? '285' : '295' // test2
              // test 2
              html += (config#uid#.battery.current.show) ? ((config#uid#.battery.power.show) ? 285 : 315) : ((config#uid#.battery.power.show) ? 295 : 325)
              //
              html += '" class="ft9-#uid# right-align#uid# '
              html += (config#uid#.battery.voltage.isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.voltage.id + '">'
              let batteryVoltage = trunc#uid#(config#uid#.battery.voltage.state, config#uid#.powerTrunc)
              html += batteryVoltage + ' ' + config#uid#.battery.voltage.unit + '</text>'
            }
            ///////////////
            ///   TEMP  ///
            ///////////////
            if (config#uid#.battery.temp.show) {
              html += '<text id="battery-temp-#uid#" fill="var(--battery_colour#uid#)" x="'
              html += (config#uid#.has_aux) ? '146' : '245'
              html += '" y="'
              //html += '295'
              // test2
              html += ((config#uid#.battery.power.show) ? 295 : 325)
              //
              html += '" class="ft9-#uid# left-align#uid# '
              html += (config#uid#.battery.temp.isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.temp.id + '">'
              let batteryTemp = trunc#uid#(config#uid#.battery.temp.state, config#uid#.powerTrunc)
              html += batteryTemp + '' + config#uid#.battery.temp.unit + '</text>'
            }
            ///////////////
            ///  DAILY  ///
            ///////////////
            if (config#uid#.battery.daily.show_charge) {
              html += '<text id="battery-daily-charge-#uid#" fill="var(--battery-charge#uid#)" x="'
              html += (config#uid#.has_aux) ? '25' : '131'
              html += '" y="343" class= "ft16-#uid# left-align#uid# '
              html += (config#uid#.battery.daily.charge_isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.daily.charge_id + '">'
              if (config#uid#.autoConversionUnit) {
                let dailyBatteryCharge = autoValueArray#uid#(config#uid#.battery.daily.charge_state, config#uid#.battery.daily.charge_unit)
                let dailyBatteryChargeAbs = trunc#uid#(Math.abs(dailyBatteryCharge.value), config#uid#.powerTrunc)
                html += formatMillier(dailyBatteryChargeAbs, config#uid#.formatMillier) + ' ' + dailyBatteryCharge.unit
              } else {
                let dailyBatteryChargeAbs = trunc#uid#(Math.abs(config#uid#.battery.daily.charge_state), config#uid#.powerTrunc)
                html += formatMillier(dailyBatteryChargeAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.daily.charge_unit
              }
              html +=  '</text>'
              html += '<text fill="var(--battery-charge#uid#)" x="'
              html += (config#uid#.has_aux) ? '25' : '131'
              html += '" y="357.2" class="ft9-#uid# left-align#uid#">'
              html += config#uid#.battery.daily.text_charge + '</text>'
            }
            if (config#uid#.battery.daily.show_discharge) {
              html += '<text id="battery-daily-discharge-#uid#" fill="var(--battery-discharge#uid#)" x="'
              html += (config#uid#.has_aux) ? '25' : '131'
              html += '" y="380.1" class="ft16-#uid# left-align#uid# '
              html += (config#uid#.battery.daily.discharge_isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.daily.discharge_id + '">'
              if (config#uid#.autoConversionUnit) {
                let dailyBatteryDischarge = autoValueArray#uid#(config#uid#.battery.daily.discharge_state, config#uid#.battery.daily.discharge_unit)
                let dailyBatteryDischargeAbs = trunc#uid#(Math.abs(dailyBatteryDischarge.value), config#uid#.powerTrunc)
                html += formatMillier(dailyBatteryDischargeAbs, config#uid#.formatMillier) + ' ' + dailyBatteryDischarge.unit
              } else {
                let dailyBatteryDischargeAbs = trunc#uid#(Math.abs(config#uid#.battery.daily.discharge_state), config#uid#.powerTrunc)
                html += formatMillier(dailyBatteryDischargeAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.daily.discharge_unit
              }
              html +=  '</text>'
              html += '<text fill="var(--battery-discharge#uid#)" x="'
              html += (config#uid#.has_aux) ? '25' : '131'
              html += '" y="393.7" class="ft9-#uid# left-align#uid#">'
              html += config#uid#.battery.daily.text_discharge + '</text>'
            }
            ///////////////
            ///   TIME  ///
            ///////////////
            html += '<text id="battery-duration-#uid#" fill="' + ((config#uid#.battery.capacity == 0) ? 'transparent' : 'var(--battery_colour#uid#)') + '" x="'
            html += (config#uid#.has_aux) ? '171' : '270'
            html += '" y="377.5" class="ft12-#uid# left-align#uid#"></text>'
            html += '<text id="battery-duration-text-#uid#" fill="' + ((config#uid#.battery.capacity == 0 || config#uid#.battery.power.state === 0) ? 'transparent' : 'var(--battery_colour#uid#)') + '" x="'
            html += (config#uid#.has_aux) ? '171' : '270'
            html += '" y="393.7" class="ft9-#uid# left-align#uid#"></text>'
            ///////////////
            /// STATE % ///
            ///////////////
            if (config#uid#.battery.state.show) {
              html += '<text id="battery-soc-#uid#" fill="var(--battery-state#uid#)" x="'
              html += (config#uid#.has_aux) ? '171' : '270'
              html += '" y="360" class="ft18-#uid# ftw-#uid# left-align#uid# '
              html += (config#uid#.battery.state.isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.state.id + '"></text>'
            }
            ///////////////
            ///  ICON   ///
            ///////////////
            let x_icon = (config#uid#.has_aux) ? 139 - (60 / 2) : 239 - (60 / 2)
            let y_icon = 335
            if (config#uid#.battery.icon) {
              if (config#uid#.battery.icon.indexOf(".") !== -1) {
                html += '<svg xmlns="http://www.w3.org/2000/svg" id="battery-icon-#uid#" x="' + x_icon + '" y="' + y_icon + '" width="60" height="60" viewBox="0 0 60 60" opacity="1">'
                html += '<image xlink:href="' + config#uid#.battery.icon + '" x="0" y="0" height="60" width="60"/>'
                html += '</svg>'
              } else {
                html += '<svg fill="var(--battery-state#uid#)" x="' + x_icon + '" y="' + y_icon + '" width="60" height="60" style="color:var(--battery_colour#uid#)">'
                //html += '<use xlink:href="plugins/powerFlow/core/template/dashboard/icon.svg#icon-' + config#uid#.battery.icon + '"/>'
                html += '<use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-' + config#uid#.battery.icon + '"/>'
                html += '</svg>'
              }
            } else {
              html += '<svg id="battery-icon-#uid#" fill="var(--battery_colour#uid#)" x="' + x_icon + '" y="' + y_icon + '" width="60" height="60" style="color:var(--battery-state#uid#)"></svg>'
            }
            ///////////////
            ///  LINE   ///
            ///////////////
            html += '<path id="battery-line-#uid#" d="'
            if (config#uid#.has_aux) { // test2
              //html += 'M 214 250 L 147 250 Q 139 250 139 258 L 139 300'
              html += 'M 214 250 L 147 250 Q 139 250 139 258 L 139 ' + ((config#uid#.battery.power.show) ? 300 : 330)
            } else {
              //if (config#uid#.battery.power.show) 
                html += 'M 239 260 L 239 ' + ((config#uid#.battery.power.show) ? 300 : 330)
              //else html += 'M 239 260 L 239 330'
            }
            //(config#uid#.has_aux) ? 'M 214 250 L 147 250 Q 139 250 139 258 L 139 300' : 'M 239 260 L 239 300' //test2
            html += '" fill="none" stroke="var(--battery_colour#uid#)" stroke-width="1" stroke-miterlimit="10"  pointer-events="stroke"/>'
            html += '<circle id="battery-dot-charge-#uid#" cx="0" cy="0" r="3" fill="transparent">'
            html += '<animateMotion id="battery-anim-charge-#uid#" dur="' + config#uid#.battery.animation_speed + 's" repeatCount="indefinite" keyPoints="0;1" keyTimes="0;1" calcMode="linear">'
            html += '<mpath xlink:href="#battery-line-#uid#"/></animateMotion></circle>'
            html += '<circle id="battery-dot-discharge-#uid#" cx="0" cy="0" r="3" fill="transparent">'
            html += '<animateMotion id="battery-anim-discharge-#uid#" dur="' + config#uid#.battery.animation_speed + 's" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear">'
            html += '<mpath xlink:href="#battery-line-#uid#"/></animateMotion></circle>'
            ///////////////////////////////////////////////////////
            /////////////////// Battery mppt //////////////////////
            ///////////////////////////////////////////////////////
            if (config#uid#.battery.mppt.has_mppt_power) {
              html += '<!-- battery mppt -->'
              html += '<rect id="battery-mppt-rect-#uid#" fill="none" stroke="var(--battery_mppt_colour#uid#)" x="'
              html += (config#uid#.has_aux) ? '204' : '303'
              html += '" y="300" width="70" height="30" rx="4.42" ry="4.42"/>'
              ///////////////
              ///  GAUGE  ///
              ///////////////
              if (config#uid#.activateGauge)
                html += '<rect id="battery-mppt-rect-gauge-#uid#" fill="var(--battery_mppt_colour#uid#)" class="op-#uid#" x="' + ((config#uid#.has_aux) ? '204' : '303') + '" y="300" width="0" height="30" rx="4.5" ry="4.5" stroke="transparent"/>'
              ///////////////
              ///  POWER  ///
              ///////////////
              html += '<text id="battery-mppt-power-#uid#" fill="var(--battery_mppt_colour#uid#)" x="'
              html += (config#uid#.has_aux) ? '240' : '337'
              html += '" y="'
              html += (config#uid#.battery.mppt.energy.show) ? '314' : '319'
              html += '" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid# '
              html += (config#uid#.battery.mppt.power.isHistorized == 1) ? 'history cursor' : ''
              html += '" data-cmd_id="' + config#uid#.battery.mppt.power.id + '">'
              if (config#uid#.autoConversionUnit) {
                let power = autoValueArray#uid#(config#uid#.battery.mppt.power.state, config#uid#.battery.mppt.power.unit)
                let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
              } else {
                let PowerAbs = trunc#uid#(Math.abs(config#uid#.battery.mppt.power.state), config#uid#.powerTrunc)
                html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.mppt.power.unit
              }
              html += '</text>'
              ///////////////
              ///  DAILY ///
              ///////////////
              if (config#uid#.battery.mppt.energy.show) {
                html += '<text id="battery-mppt-daily-#uid#" fill="var(--battery_mppt_colour#uid#)" x="'
                html += (config#uid#.has_aux) ? '240' : '337'
                html += '" y="325" class="ft8-#uid# center-align#uid# sh-#uid# '
                html += (config#uid#.battery.mppt.energy.isHistorized == 1) ? 'history cursor' : ''
                html += '" data-cmd_id="' + config#uid#.battery.mppt.energy.id + '">'
                if (config#uid#.autoConversionUnit) {
                  let mppt_energy = autoValueArray#uid#(config#uid#.battery.mppt.energy.state, config#uid#.battery.mppt.energy.unit)
                  let mppt_energyAbs = trunc#uid#(Math.abs(mppt_energy.value), config#uid#.powerTrunc)
                  html += formatMillier(mppt_energyAbs, config#uid#.formatMillier) + ' ' + mppt_energy.unit
                } else {
                  let mppt_energyAbs = trunc#uid#(Math.abs(config#uid#.battery.mppt.energy.state), config#uid#.powerTrunc)
                  html += formatMillier(mppt_energyAbs, config#uid#.formatMillier) + ' ' + config#uid#.battery.mppt.energy.unit
                }
                html += '</text>'
              }
              ///////////////
              ///  LINE   ///
              ///////////////
              html += '<path id="battery-mppt-line-#uid#" d="' + ((config#uid#.has_aux) ? 'M 175 315 L 204 315' : 'M 274 315 L 303 315') + '" fill="none" stroke="var(--battery_mppt_colour#uid#)" stroke-width="1" stroke-miterlimit="10"/>'
              html += '<circle id="battery-mppt-dot-#uid#" cx="0" cy="0" r="3" fill="' + ((parseInt(config#uid#.battery.mppt.power.state) <= 0) ? 'transparent' : 'var(--battery_mppt_colour#uid#)') + '">'
              html += '<animateMotion id="battery-mppt-animate-#uid#" dur="5s" repeatCount="indefinite" keyPoints="1;0" keyTimes="0;1" calcMode="linear"><mpath xlink:href="#battery-mppt-line-#uid#"/></animateMotion></circle>'
              ///////////////
              ///  NAME  ///
              ///////////////
              html += '<text x="' + ((config#uid#.has_aux) ? '239' : '338') + '" y="295" class="ft9-#uid# ftw-#uid# center-align#uid#" fill="var(--battery_mppt_colour#uid#)">' + config#uid#.battery.mppt.name + '</text>'
            }
          }
          ///////////////////////////////////////////////////
          ////////////////////// Aux ////////////////////////
          ///////////////////////////////////////////////////
          if (config#uid#.has_aux) {
            html += '<!-- Aux -->'
            //html += '<rect id="aux-rect-#uid#" class="" x="' + ((config#uid#.battery.power.show) ? '304' : '204') + '" y="300" width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke="var(--aux_colour#uid#)" pointer-events="all"/>'//test2
            // test2
            html += '<rect id="aux-rect-#uid#" class="" x="' + ((config#uid#.has_battery) ? '304' : '204') + '" y="300" width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke="var(--aux_colour#uid#)" pointer-events="all"/>'
            ///////////////
            ///  GAUGE  ///
            ///////////////
            if (config#uid#.activateGauge)
              html += '<rect id="aux-rect-gauge-#uid#" class="op-#uid#" x="' + ((config#uid#.has_battery) ? '304' : '204') + '" y="300" width="0" height="30" rx="4.5" ry="4.5" fill="var(--aux_colour#uid#)" stroke="none" pointer-events="all"/>'
            ///////////////
            ///  POWER  ///
            ///////////////
            html += '<text id="aux-power-#uid#" x="' + ((config#uid#.has_battery) ? '339' : '239') + '" y="320" class="ft12-#uid# ftw-#uid# center-align#uid# sh-#uid# ' + ((config#uid#.aux.isHistorized == 1) ? 'history cursor' : '') + '" fill="var(--aux_colour#uid#)" data-cmd_id=' + config#uid#.aux.id + '>'
            if (config#uid#.autoConversionUnit) {
              let power = autoValueArray#uid#(config#uid#.aux.power, config#uid#.aux.power_unit)
              let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
            } else {
              let PowerAbs = trunc#uid#(Math.abs(config#uid#.aux.power), config#uid#.powerTrunc)
              html += formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.aux.power_unit
            }
            html += '</text>'
            //html += formatMillier(trunc#uid#(config#uid#.aux.power, 1), config#uid#.formatMillier) + ' ' + config#uid#.aux.power_unit + '</text>'
            ///////////////
            ///  LINE   ///
            ///////////////
            html += '<path id="aux-line-#uid#" d="' + ((config#uid#.has_battery) ? 'M 339 300 L 339 258 Q 339 250 331 250 L 264 250' : 'M 239.23 300 L 239.23 260') + '" fill="none" stroke="var(--aux_colour#uid#)" stroke-width="1" stroke-miterlimit="10" pointer-events="stroke"></path>'
            html += '<circle id="aux-dot-#uid#" cx="0" cy="0" r="3" fill="' + ((config#uid#.aux.power == 0) ? 'transparent' : 'var(--aux_colour#uid#)') + '">'
            html += '<animateMotion id="aux-anim-#uid#" dur="' + config#uid#.aux.animation_speed + 's" repeatCount="indefinite" keyPoints="0;1" keyTimes="0;1" calcMode="linear">'
            html += '<mpath xlink:href="#aux-line-#uid#"/></animateMotion></circle>'
            ///////////////
            ///  ICON   ///
            ///////////////
            html += '<svg id="aux_icon-#uid#" fill="var(--aux_colour#uid#)" x="' + ((config#uid#.has_battery) ? '299' : '199') + '" y="325" width="80" height="80" style="color:var(--aux_colour#uid#)"><use xlink:href="plugins/powerFlow/desktop/images/icon.svg#icon-aux"></use></svg>'
            ///////////////
            ///  DAILY  ///
            ///////////////
            if (config#uid#.aux.daily.show) {
              
              html += '<text id="aux-daily-#uid#" x="' + ((config#uid#.has_battery) ? '385' : '131') + '" y="' + ((config#uid#.has_battery) ? '380' : '380.1') + '" class="ft16-#uid# left-align#uid# '
              html += (config#uid#.aux.daily.isHistorized == 1) ? 'history cursor' : ''
              html += '" fill="var(--aux_colour#uid#)" data-cmd_id=' + config#uid#.aux.daily.id + '>'
              if (config#uid#.autoConversionUnit) {
                let dailyAux = autoValueArray#uid#(config#uid#.aux.daily.state, config#uid#.aux.daily.unit)
                let dailyAuxAbs = trunc#uid#(Math.abs(dailyAux.value), config#uid#.powerTrunc)
                html += formatMillier(dailyAuxAbs, config#uid#.formatMillier) + ' ' + dailyAux.unit
              } else {
                let dailyAuxAbs = trunc#uid#(Math.abs(config#uid#.aux.daily.state), config#uid#.powerTrunc)
                html += formatMillier(dailyAuxAbs, config#uid#.formatMillier) + ' ' + config#uid#.aux.daily.unit
              }
              html += '</text>'
              html += '<text x="' + ((config#uid#.has_battery) ? '385' : '131') + '" y="' + ((config#uid#.has_battery) ? '393.7' : '393.7') + '" class="ft9-#uid# left-align#uid#" fill="var(--aux_colour#uid#)">' + config#uid#.aux.daily.text + '</text>'
            }
          }
          ///////////////////////////////////////////////////////
          ///////////////////// Inverter ////////////////////////
          ///////////////////////////////////////////////////////
          html += '<!-- Inverter -->'
          ///////////////
          ///  ICON   ///
          ///////////////
          if (config#uid#.inverter.model == 'defaut') {
            html += '<svg version="1.0" xmlns="http://www.w3.org/2000/svg" x="213.5" y="189" width="54" height="79" viewBox="0 0 74 91"  preserveAspectRatio="xMidYMid meet"> '
            html += '<g transform="translate(0.000000,91.000000) scale(0.100000,-0.100000)" fill="var(--inverter_colour#uid#)" stroke="none"> <path d="M35 887 l-27 -23 0 -404 0 -404 27 -23 c26 -23 28 -23 329 -23 284 0 305 1 327 19 l24 19 0 412 0 412 -24 19 c-22 18 -43 19 -327 19 -301 0 -303 0 -329 -23z m585 -157 l0 -80 -255 0 -255 0 0 80 0 80 255 0 255 0 0 -80z m-242 -229"/> </g> </svg>'
          } else if (config#uid#.inverter.model == 'none') {
            html += '<rect x="214" y="196" width="50" height="64" rx="4.5" ry="4.5" fill="none" stroke="var(--inverter_colour#uid#)" pointer-events="all"></rect>'
          } else {
            html += '<image xlink:href="' + config#uid#.inverter.model + '" x="214" y="196" height="64" width="50" preserveAspectRatio="none"></image>'
          }
          ///////////////
          ///   LCD   ///
          ///////////////
          if (config#uid#.inverter.lcd_state !== false) {
            html += '<text id="inverter_lcd#uid#" '
            html += 'x="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 240 : 269) + '" '
            html += 'y="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 211 : 205) + '" '
            html += 'class="ft8-#uid# ' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 'center-align#uid#' : 'left-align#uid#') + ' '
            html += (config#uid#.inverter.lcd_isHistorized == 1) ? 'history cursor' : ''
            html +=  '" fill="var(--inverter_colour#uid#)"' + ((config#uid#.inverter.lcd_id) ? ' data-cmd_id="' + config#uid#.inverter.lcd_id : '') + '">'
            html += config#uid#.inverter.lcd_state + ' ' + config#uid#.inverter.lcd_unit + '</text>'
          }
          ///////////////
          /// VOLTAGE ///
          ///////////////
          if (config#uid#.inverter.voltage_state !== false) {
            html += '<text id="inverter_voltage#uid#" '
            html += 'x="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 239 : 210) + '" '
            html += 'y="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 230 : 205) + '" '
            html += 'class="ft9-#uid# ' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 'center-align#uid#' : 'right-align#uid#') + ' '
            html += (config#uid#.inverter.voltage_isHistorized == 1) ? 'history cursor' : ''
            html +=  '" fill="' + ((config#uid#.inverter.model == 'defaut') ? 'var(--inverter_secondary_colour#uid#)' : 'var(--inverter_colour#uid#)') + '" data-cmd_id="' + config#uid#.inverter.voltage_id + '">'
            html += trunc#uid#(config#uid#.inverter.voltage_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.voltage_unit + '</text>'
          }
          /////////////////
          /// FREQUENCY ///
          /////////////////
          if (config#uid#.inverter.frequency_state !== false) {
            html += '<text id="inverter_frequency#uid#" '
            html += 'x="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 239 : 210) + '" '
            html += 'y="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 240 : 215) + '" '
            html += 'class="ft9-#uid# ' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 'center-align#uid#' : 'right-align#uid#') + ' '
            html += (config#uid#.inverter.frequency_isHistorized == 1) ? 'history cursor' : ''
            html += '" fill="' + ((config#uid#.inverter.model == 'defaut') ? 'var(--inverter_secondary_colour#uid#)' : 'var(--inverter_colour#uid#)') + '" data-cmd_id="' + config#uid#.inverter.frequency_id + '">'
            html += trunc#uid#(config#uid#.inverter.frequency_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.frequency_unit + '</text>'
          }
          ///////////////
          /// CURRENT ///
          ///////////////
          if (config#uid#.inverter.current_state !== false) {
            html += '<text id="inverter_current#uid#" '
            html += 'x="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 239 : 210) + '" '
            html += 'y="' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 250 : 225) + '" '
            html += 'class="ft9-#uid# ' + ((config#uid#.inverter.model == 'defaut' || config#uid#.inverter.model == 'none') ? 'center-align#uid#' : 'right-align#uid#') + ' '
            html += (config#uid#.inverter.current_isHistorized == 1) ? 'history cursor' : ''
            html += '" fill="' + ((config#uid#.inverter.model == 'defaut') ? 'var(--inverter_secondary_colour#uid#)' : 'var(--inverter_colour#uid#)') + '" data-cmd_id="' + config#uid#.inverter.current_id + '">'
            html += trunc#uid#(config#uid#.inverter.current_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.current_unit + '</text>'
          }
          ///////////////
          ///   TEMP  ///
          ///////////////
          if (config#uid#.inverter.temp.ac_state !== false) {
            //ac
            html += '<text id="ac_temp#uid#" '
            html += 'x="' + ((config#uid#.has_load) ? '266' : '210') + '" y="242" '
            html += 'class="ft9-#uid# ' + ((config#uid#.has_load) ? 'left-align#uid#' : 'right-align#uid#') + ' '
            html += (config#uid#.inverter.temp.ac_isHistorized == 1) ? 'history cursor' : ''
            html += '" fill="var(--inverter_colour#uid#)" data-cmd_id="' + config#uid#.inverter.temp.ac_id + '">'
            html += trunc#uid#(config#uid#.inverter.temp.ac_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.temp.ac_unit + '</text>'
          }
          if (config#uid#.inverter.temp.dc_state !== false) {
            //dc
            html += '<text id="dc_temp#uid#" '
            html += 'x="243" y="' + ((config#uid#.has_solar || (!config#uid#.has_solar && !config#uid#.has_battery)) ? '192' : '272') + '" '
            html += 'class="ft9-#uid# left-align#uid# '
            html += (config#uid#.inverter.temp.dc_isHistorized == 1) ? 'history cursor' : ''
            html += '" fill="var(--inverter_colour#uid#)"  data-cmd_id="' + config#uid#.inverter.temp.dc_id + '">'
            html += trunc#uid#(config#uid#.inverter.temp.dc_state, config#uid#.powerTrunc) + ' ' + config#uid#.inverter.temp.dc_unit + '</text>'
          }
         
         /* 
          html += '<!-- Test -->'
          html += '<text id="energy_cost#uid#" x="105" y="195" class="ft9-#uid# left-align#uid#" fill="var(--grid_colour#uid#)" >' + config#uid#.grid.energy_cost + '€</text>'
         */
         /* 
          html += '<text id="autarkye_value#uid#" x="130" y="260" display="' + ((config#uid#.inverter.autarky === "no") ? 'none' : '') + '" class="' + ((config#uid#.inverter.autarky === 'energy') ? 'ft14-#uid# ftw-#uid# left-align#uid#' : 'hidden-#uid#') + '" fill="var(--inverter_colour#uid#)" >' + config#uid#.inverter.autarky_state + '%</text>'
          
          html += '<text id="ratioe_value#uid#" x="173" y="260" display="'
          //html += (config#uid#.inverter.autarky === "no") ? 'none' : ''
          html += '" class="'
          //html += (config#uid#.inverter.autarky === 'energy') ? 'ft14-#uid# ftw-#uid# left-align#uid#' : 'hidden-#uid#'
          html += '" fill="var(--inverter_colour#uid#)" >' + config#uid#.inverter.ratio_state + '%</text>'
    
          html += '<text id="autarkyp_value#uid#" x="130" y="260" display="'
          //html += (config#uid#.inverter.autarky === "no") ? 'none' : ''
          html += '" class="'
          //html += (config#uid#.inverter.autarky === 'power') ? 'ft14-#uid# ftw-#uid# left-align#uid#' : 'hidden-#uid#'
          html += '" fill="var(--inverter_colour#uid#)" >' + config#uid#.inverter.autarkyp_state + '%</text>'
    
          html += '<text id="ratiop_value#uid#" x="173" y="260" display="'
          //html += (config#uid#.inverter.autarky === "no") ? 'none' : ''
          html += '" class="'
          //html += (config#uid#.inverter.autarky === 'power') ? 'ft14-#uid# ftw-#uid# left-align#uid#' : 'hidden-#uid#'
          html += '" fill="var(--inverter_colour#uid#)" >'  + config#uid#.inverter.ratiop_state + '%</text>'
    
          html += '<text id="autarky#uid#" x="130" y="273" display="'
          //html += (config#uid#.inverter.autarky === "no") ? 'none' : ''
          html += '" class="ft9-#uid# left-align#uid#" fill="var(--inverter_colour#uid#)" >' + config#uid#.inverter.autarky_text + '</text>'
    
          html += '<text id="ratio#uid#" x="173" y="273" display="'
          //html += (config#uid#.inverter.autarky === "no") ? 'none' : ''
          html += '" class="ft9-#uid# left-align#uid#" fill="var(--inverter_colour#uid#)" >' + config#uid#.inverter.ratio_text + '</text>'
          */
          if (!jeedom.cmd.disableExecute) document.getElementById('widget#uid#').innerHTML = html
          else {
            if (document.body.getAttribute('data-page') == 'plan') {
              document.getElementById("div_error#uid#").innerHTML = 'La configuration de l\'équipement a été modifiée.<br>Veuillez actualiser le design.'
            } else {
              document.getElementById("div_error#uid#").innerHTML = 'La configuration de l\'équipement a été modifiée.<br>Veuillez sortir du mode édition pour réactualiser le widget'
            }
            document.getElementById("div_error#uid#").classList.remove("hidden-#uid#")
          }
        } // init
      } // ElDomExist
      log#uid#('└──────────────────────────────────────────────────────')
      if (config#uid#.has_solar !== false) calculatePv#uid#('init');
      if (config#uid#.has_load) calculateLoad#uid#('init');
      if (config#uid#.has_battery) calculateBattery#uid#('init')
      if (config#uid#.has_aux !== false) calculateAux#uid#('init')
      if (config#uid#.grid.has_grid_power) calculateGrid#uid#('init') // config#uid#.has_grid !== false
      //calculateGaugeRatio#uid#('init') // lanuched by calculateGrid
    }
    
    function calculatePv#uid#(el='') {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [calculatePv()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#");
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {  
        if (el != '') log#uid#('| launched by ' + el)
        log#uid#('| has_pv_power ? ' + config#uid#.solar.has_pv_power)
        
        ///  POWER  \\\
        if (config#uid#.solar.has_pv_power === false) {
          var differentUnit = false
          for (solar in config#uid#.solars) {
            if (differentUnit === false) {
              differentUnit = config#uid#.solars[solar].power_unit
            } else if (config#uid#.solars[solar].power_unit != differentUnit) {
              differentUnit = true
              break
            }
          }
          if (differentUnit === true) {
            log#uid#('| /!\\ ------- Unités differentes entre PV !!!')
            document.getElementById("widget#uid#")?.classList.add("hidden-#uid#")
            document.getElementById("div_error#uid#").classList.remove("hidden-#uid#")
            var html_error = '<center><h2><i class="icon fas fa-exclamation-triangle"></i> Unités differentes entre <b>PV</b></h2></center>'
            html_error += '<br>Causes possibles :<br><ul>'
            html_error += '<li>Unités à paramètrer dans les commandes sources.</li>'
            html_error += '<li>Commandes sources inexistante. (voir page santé du plugin.)</li>'
            html_error += '</ul>Veuillez apporter les corrections et actualiser le widget.'
            document.getElementById("div_error#uid#").innerHTML = html_error
          } else {
            config#uid#.solar.power_unit = 'W'
            config#uid#.solar.power = 0
            for (solar in config#uid#.solars) {
               config#uid#.solar.power = config#uid#.solar.power + (config#uid#.solars[solar].power * 1000)
            }
            config#uid#.solar.power = config#uid#.solar.power / 1000
            if (is_object(cmdPower = document.getElementById("pv-power-#uid#"))) {
              if (config#uid#.autoConversionUnit) {
                let power = autoValueArray#uid#(config#uid#.solar.power, config#uid#.solar.power_unit)
                let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                cmdPower.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
              } else {
                let PowerAbs = trunc#uid#(Math.abs(config#uid#.solar.power), config#uid#.powerTrunc)
                cmdPower.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.solar.power_unit
              }
            }
          }
        }
        
        ///  GAUGE  \\\
        if (config#uid#.solar.max_power) {
          if (config#uid#.activateGauge) {
            let gaugePourcent = config#uid#.solar.power * 100 / config#uid#.solar.max_power
            let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
            document.getElementById("pv-rect-gauge-#uid#")?.setAttribute('width', width_rect_gauge)
          } else document.getElementById("pv-rect-gauge-#uid#")?.setAttribute('width', 0)
        }
        
        ///  ALERT  \\\
        if (config#uid#.solar.has_pv_power === false) {
          if (config#uid#.solar.alert_power) {
            if (Math.abs(config#uid#.solar.power) >= Math.abs(config#uid#.solar.alert_power)) {
              if (config#uid#.blink) {
                document.getElementById("pv-rect-#uid#")?.classList.add("blink#uid#")
                document.getElementById("pv-rect-gauge-#uid#")?.classList.add("blink#uid#")
                //if (config#uid#.font_alert) document.getElementById("pv-power-#uid#")?.classList.add("blink#uid#")
              }
              if (config#uid#.font_alert) document.getElementById("pv-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
              document.getElementById("pv-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
              document.getElementById("pv-line-1-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
              document.getElementById("pv-line-2-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
              document.getElementById("pv-power-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
            } else {
              if (config#uid#.blink) {
                document.getElementById("pv-rect-#uid#")?.classList.remove("blink#uid#")
                document.getElementById("pv-rect-gauge-#uid#")?.classList.remove("blink#uid#")
                //if (config#uid#.font_alert) document.getElementById("pv-power-#uid#")?.classList.remove("blink#uid#")
              }
              if (Math.abs(config#uid#.solar.power) > 0) {
                document.getElementById("pv-power-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
                document.getElementById("pv-rect-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
                document.getElementById("pv-line-1-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
                document.getElementById("pv-line-2-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
              } else {
                document.getElementById("pv-power-#uid#")?.setAttribute("fill", "var(--solar_colour-0-#uid#)")
                document.getElementById("pv-rect-#uid#")?.setAttribute("stroke", "var(--solar_colour-0-#uid#)")
                document.getElementById("pv-line-1-#uid#")?.setAttribute("stroke", "var(--solar_colour-0-#uid#)")
                document.getElementById("pv-line-2-#uid#")?.setAttribute("stroke", "var(--solar_colour-0-#uid#)")
              }
            }
          }
        } else {
          if (config#uid#.solar.alert_power) {
            if (Math.abs(config#uid#.solar.power) >= Math.abs(config#uid#.solar.alert_power)) {
              if (config#uid#.blink) {
                document.getElementById("pv-rect-#uid#")?.classList.add("blink#uid#")
                document.getElementById("pv-rect-gauge-#uid#")?.classList.add("blink#uid#")
                //if (config#uid#.font_alert) document.getElementById("pv-power-#uid#")?.classList.add("blink#uid#")
              }
              if (config#uid#.font_alert) document.getElementById("pv-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
              document.getElementById("pv-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
            } else {
              if (config#uid#.blink) {
                document.getElementById("pv-rect-#uid#")?.classList.remove("blink#uid#")
                document.getElementById("pv-rect-gauge-#uid#")?.classList.remove("blink#uid#")
                //if (config#uid#.font_alert) document.getElementById("pv-power-#uid#")?.classList.remove("blink#uid#")
              }
              if (config#uid#.font_alert) document.getElementById("pv-power-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
              document.getElementById("pv-rect-#uid#")?.setAttribute("stroke", "var(--solar_colour#uid#)")
              
            }
          }
        }
        
        ///  DOT  \\\
        if (Math.abs(config#uid#.solar.power) > 0) {
          document.getElementById("pv-dot-1-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
          document.getElementById("pv-dot-2-#uid#")?.setAttribute("fill", "var(--solar_colour#uid#)")
        } else {
          document.getElementById("pv-dot-1-#uid#")?.setAttribute("fill", "transparent")
          document.getElementById("pv-dot-2-#uid#")?.setAttribute("fill", "transparent")
        }
        
        ///  SPEED  \\\
        log#uid#('| total_pv = ' + config#uid#.solar.power)
        let speed = config#uid#.solar.animation_speed - ((config#uid#.solar.animation_speed - 1.5) * (config#uid#.solar.power / (config#uid#.solar.max_power || config#uid#.solar.power)))
        speed = (speed >= 1.5) ? speed : 1.5
        log#uid#('| animation_speed = ' + speed)
        document.getElementById("pv-anim-1-#uid#")?.setAttribute("dur",speed)
        document.getElementById("pv-anim-2-#uid#")?.setAttribute("dur",speed)
      }
      log#uid#('└──────────────────────────────────────────────────────')
      if (config#uid#.has_load && el != 'init' && config#uid#.activateGaugeRatio) calculateGaugeRatio#uid#('calculatePv')
    }    
    
    function calculateLoad#uid#(el='') {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [calculateLoad()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#");
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {  
        if (el != '') log#uid#('| launched by ' + el)
        log#uid#('| has_load_power ? ' + config#uid#.load.has_load_power)
        
        /// POWER CALCUL \\\
        if (config#uid#.load.has_load_power === false) {
          var differentUnit = false
          //config#uid#.load.power_unit = config#uid#.loads[1].power_unit
          for (load in config#uid#.loads) {
            if (differentUnit === false) {
              differentUnit = config#uid#.loads[load].power_unit
            } else if (config#uid#.loads[load].power_unit != differentUnit) {
              differentUnit = true
              break
            }
          }
          if (differentUnit === true) {
            log#uid#('| /!\\ ------- Attention unité differente entre load, calcul impossible !!!')
            document.getElementById("widget#uid#")?.classList.add("hidden-#uid#")
            document.getElementById("div_error#uid#")?.classList.remove("hidden-#uid#")
            var html_error = '<center><h2><i class="icon fas fa-exclamation-triangle"></i> Unités differentes entre <b>RECEPTEURS</b></h2></center>'
            html_error += '<br>Causes possibles :<br><ul>'
            html_error += '<li>Unités à paramètrer dans les commandes sources.</li>'
            html_error += '<li>Commandes sources inexistante. (voir page santé du plugin.)</li>'
            html_error += '</ul>Veuillez apporter les corrections et actualiser le widget.'
            document.getElementById("div_error#uid#").innerHTML = html_error
          } else {
            config#uid#.load.power_unit = 'W'
            config#uid#.load.power = 0
            for (load in config#uid#.loads) {
               if (isset(config#uid#.loads[load].power)) config#uid#.load.power = config#uid#.load.power + (config#uid#.loads[load].power * 1000)
            }
            config#uid#.load.power = config#uid#.load.power / 1000
            if (is_object(cmd = document.getElementById("load-power-#uid#"))) {
              if (config#uid#.autoConversionUnit) {
                let power = autoValueArray#uid#(config#uid#.load.power, config#uid#.load.power_unit)
                let PowerAbs = trunc#uid#(Math.abs(power.value), config#uid#.powerTrunc)
                cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + power.unit
              } else {
                let PowerAbs = trunc#uid#(Math.abs(config#uid#.load.power), config#uid#.powerTrunc)
                cmd.innerHTML = formatMillier(PowerAbs, config#uid#.formatMillier) + ' ' + config#uid#.load.power_unit
              }
            }
          }
        }
        
        ///  GAUGE  \\\
        if (config#uid#.load.max_power) {
          if (config#uid#.activateGauge) {
            let gaugePourcent = config#uid#.load.power * 100 / config#uid#.load.max_power
            let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
            document.getElementById("load-rect-gauge-#uid#")?.setAttribute('width', width_rect_gauge)
          } else document.getElementById("load-rect-gauge-#uid#")?.setAttribute('width', 0)
        }
        
        /// ALERT  \\\
        if (config#uid#.load.alert_power && config#uid#.load.power >= config#uid#.load.alert_power) {
          document.getElementById("load-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
          if (config#uid#.font_alert) document.getElementById("load-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
          if (config#uid#.blink) {
            document.getElementById("load-rect-#uid#")?.classList.add("blink#uid#")
            document.getElementById("load-rect-gauge-#uid#")?.classList.add("blink#uid#")
            //if (config#uid#.font_alert) document.getElementById("load-power-#uid#")?.classList.add("blink#uid#")
          }
        } else {
          document.getElementById("load-rect-#uid#")?.setAttribute("stroke", "var(--load_colour#uid#)")
          if (config#uid#.font_alert) document.getElementById("load-power-#uid#")?.setAttribute("fill", "var(--load_colour#uid#)")
          if (config#uid#.blink) {
            document.getElementById("load-rect-#uid#")?.classList.remove("blink#uid#")
            document.getElementById("load-rect-gauge-#uid#")?.classList.remove("blink#uid#")
            //if (config#uid#.font_alert) document.getElementById("load-power-#uid#")?.classList.remove("blink#uid#")
          }
        }
        log#uid#('| total_load = ' + config#uid#.load.power)
        
        ///  DOT  \\\
        if(config#uid#.load.power > 0) {
          document.getElementById("load-dot1-#uid#")?.setAttribute("fill", "var(--load_colour#uid#)")
          document.getElementById("load-dot2-#uid#")?.setAttribute("fill", "var(--load_colour#uid#)")
        } else {
          document.getElementById("load-dot1-#uid#")?.setAttribute("fill", "transparent")
          document.getElementById("load-dot2-#uid#")?.setAttribute("fill", "transparent")
        }

        /// SPEED  \\\
        let speed = Math.max((5 - (4 * (config#uid#.load.power / (config#uid#.load.max_power || config#uid#.load.power)))), 1)
        log#uid#('| animation_speed = ' + speed)
        document.getElementById("load-anim1-#uid#")?.setAttribute("dur",speed)
        document.getElementById("load-anim2-#uid#")?.setAttribute("dur",speed)
      }
      log#uid#('└──────────────────────────────────────────────────────')
      if (config#uid#.has_load && el != 'init' && config#uid#.activateGaugeRatio) calculateGaugeRatio#uid#('calculateLoad')
    }
    
    function calculateAux#uid#(el='') {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [calculateAux()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#")
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {
        if (el != '') log#uid#('| launched by ' + el)
        
        ///  GAUGE  \\\
        if (config#uid#.aux.max_power) {
          if (config#uid#.activateGauge) {
            let gaugePourcent = config#uid#.aux.power * 100 / config#uid#.aux.max_power
            let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
            document.getElementById("aux-rect-gauge-#uid#")?.setAttribute('width', width_rect_gauge)
          } else document.getElementById("aux-rect-gauge-#uid#")?.setAttribute('width', 0)
        }
        
        ///  ALERT  \\\
        if (config#uid#.aux.alert_power && config#uid#.aux.power >= config#uid#.aux.alert_power) {
          document.getElementById("aux-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
          if (config#uid#.font_alert) document.getElementById("aux-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
          if (config#uid#.blink) {
            document.getElementById("aux-rect-#uid#")?.classList.add("blink#uid#")
            document.getElementById("aux-rect-gauge-#uid#")?.classList.add("blink#uid#")
            //if (config#uid#.font_alert) document.getElementById("aux-power-#uid#")?.classList.add("blink#uid#")
          }
        } else {
          document.getElementById("aux-rect-#uid#")?.setAttribute("stroke", "var(--aux_colour#uid#)")
          if (config#uid#.font_alert) document.getElementById("aux-power-#uid#")?.setAttribute("fill", "var(--aux_colour#uid#)")
          if (config#uid#.blink) {
            document.getElementById("aux-rect-#uid#")?.classList.remove("blink#uid#")
            document.getElementById("aux-rect-gauge-#uid#")?.classList.remove("blink#uid#")
            //if (config#uid#.font_alert) document.getElementById("aux-power-#uid#")?.classList.remove("blink#uid#")
          }
        }
        
        ///  DOT  \\\
        if (config#uid#.aux.power > 0) document.getElementById("aux-dot-#uid#")?.setAttribute("fill", "var(--aux_colour#uid#)")
        else document.getElementById("aux-dot-#uid#")?.setAttribute("fill", "transparent")
        
        ///  SPEED  \\\
        let speed = config#uid#.aux.animation_speed - ((config#uid#.aux.animation_speed - 1.5) * ((config#uid#.aux.power) / (config#uid#.aux.max_power || config#uid#.aux.power)))
        speed = (speed >= 1.5) ? speed : 1.5
        document.getElementById("aux-anim-#uid#")?.setAttribute("dur",speed)
        log#uid#('| animation_speed = ' + config#uid#.aux.animation_speed)
        log#uid#('| new animation_speed = ' + speed)
      } // ElDomExist
      log#uid#('└──────────────────────────────────────────────────────')
      if (config#uid#.has_load && el != 'init' && config#uid#.activateGaugeRatio) calculateGaugeRatio#uid#('calculateAux')
    }
    
    function calculateBattery#uid#(el='') {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [calculateBattery()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#")
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {
        if (el != '') log#uid#('| launched by ' + el)
        if (el == 'init' || el == 'battery state'){
          ///  ICON  \\\
          if (!config#uid#.battery.icon) {
            document.getElementById("battery-icon-#uid#").innerHTML = getBatteryIcon#uid#(config#uid#.battery.state.state, config#uid#.battery.full_capacity, config#uid#.battery.empty_capacity)
            if (config#uid#.battery.autoColorBattery) {
              ///  set color icon & state  \\\
              let color_battery = 'var(--battery_colour#uid#)'
              if (config#uid#.battery.state.state <= 0) color_battery = 'var(--battery-state-0-#uid#)'
              else if (config#uid#.battery.state.state < 50) color_battery = 'var(--battery-state-25-#uid#)'
              else if (config#uid#.battery.state.state < 75) color_battery = 'var(--battery-state-50-#uid#)'
              else if (config#uid#.battery.state.state < 100) color_battery = 'var(--battery-state-75-#uid#)'
              else color_battery = 'var(--battery-state-100-#uid#)'
              document.getElementById("battery-icon-#uid#").style.color = color_battery
              document.getElementById("battery-soc-#uid#")?.setAttribute("fill", color_battery)
            }
          }
          if (config#uid#.battery.state.show) document.getElementById("battery-soc-#uid#").innerHTML = trunc#uid#(config#uid#.battery.state.state, 1) + '%'
        }
        if (el == 'init' || el == 'battery power' || el == 'battery mppt power') {
          let totalFromInverter = (config#uid#.battery.power.state < 0) ? Math.min(config#uid#.battery.power.state + config#uid#.battery.mppt.power.state, 0) : config#uid#.battery.power.state
          log#uid#('| totalFromInverter : ' + totalFromInverter)
          let color = 'var(--battery_colour#uid#)'
          
          ///  GAUGE POWER  \\\
          if (el != 'battery mppt power') {
            if (config#uid#.battery.max_power) {
              if (config#uid#.activateGauge) {
                if (Math.abs(config#uid#.battery.power.state) > 0) {
                  let gaugePourcent = Math.abs(config#uid#.battery.power.state) * 100 / config#uid#.battery.max_power
                  let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
                  document.getElementById("battery-rect-gauge-#uid#")?.setAttribute('width', width_rect_gauge)
                } else document.getElementById("battery-rect-gauge-#uid#")?.setAttribute('width', 0)
              }
            }
          }
          ///  GAUGE MPPT  \\\
          if (el != 'battery power') {
            if (config#uid#.battery.mppt.max_power) {
              if (config#uid#.activateGauge) {
                if (Math.abs(config#uid#.battery.mppt.power.state) > 0) {
                  let gaugePourcent = Math.abs(config#uid#.battery.mppt.power.state) * 100 / config#uid#.battery.mppt.max_power
                  let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
                  document.getElementById("battery-mppt-rect-gauge-#uid#")?.setAttribute('width', width_rect_gauge)
                } else document.getElementById("battery-mppt-rect-gauge-#uid#")?.setAttribute('width', 0)
              }
            }
          }
          
          ///  DOT  \\\
          if (parseFloat(totalFromInverter) > 0) {
            document.getElementById("battery-dot-charge-#uid#")?.setAttribute("fill", "transparent")
            document.getElementById("battery-dot-discharge-#uid#")?.setAttribute("fill", "var(--battery-discharge#uid#)") //--battery_colour#uid#
            color = 'var(--battery-discharge#uid#)'
          }
          else if (parseFloat(totalFromInverter) < 0) {
            document.getElementById("battery-dot-charge-#uid#")?.setAttribute("fill", "var(--battery-charge#uid#)") //--battery_colour#uid#
            document.getElementById("battery-dot-discharge-#uid#")?.setAttribute("fill", "transparent")
            color = 'var(--battery-charge#uid#)'
          }
          else {
            document.getElementById("battery-dot-charge-#uid#")?.setAttribute("fill", "transparent")
            document.getElementById("battery-dot-discharge-#uid#")?.setAttribute("fill", "transparent")
          }
          
          ///  COLOR  \\\
          document.getElementById("battery-line-#uid#")?.setAttribute("stroke", color)
          document.getElementById("battery-rect-gauge-#uid#")?.setAttribute("fill", color)
          document.getElementById("battery-duration-#uid#")?.setAttribute("fill", color)
          document.getElementById("battery-duration-text-#uid#")?.setAttribute("fill", color)
          
          ///  ALERTE POWER \\\
          if (config#uid#.battery.alert_power && config#uid#.battery.power.state >= config#uid#.battery.alert_power) {
            document.getElementById("battery-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
            if (config#uid#.font_alert) document.getElementById("battery-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
            if (config#uid#.blink) {
              document.getElementById("battery-rect-#uid#")?.classList.add("blink#uid#")
              document.getElementById("battery-rect-gauge-#uid#")?.classList.add("blink#uid#")
              //if (config#uid#.font_alert) document.getElementById("battery-power-#uid#")?.classList.add("blink#uid#")
            }
          } else {
            document.getElementById("battery-rect-#uid#")?.setAttribute("stroke", color)
            document.getElementById("battery-power-#uid#")?.setAttribute("fill", color)
            if (config#uid#.blink) {
              document.getElementById("battery-rect-#uid#")?.classList.remove("blink#uid#")
              document.getElementById("battery-rect-gauge-#uid#")?.classList.remove("blink#uid#")
              //if (config#uid#.font_alert) document.getElementById("battery-power-#uid#")?.classList.remove("blink#uid#")
            }
          }
          
          ///  ALERTE MPPT POWER \\\
          if (config#uid#.battery.mppt.alert_power && config#uid#.battery.mppt.power.state >= config#uid#.battery.mppt.alert_power) {
            document.getElementById("battery-mppt-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
            if (config#uid#.font_alert) document.getElementById("battery-mppt-power-#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
            if (config#uid#.blink) {
              document.getElementById("battery-mppt-rect-#uid#")?.classList.add("blink#uid#")
              document.getElementById("battery-mppt-rect-gauge-#uid#")?.classList.add("blink#uid#")
              //if (config#uid#.font_alert) document.getElementById("battery-mppt-power-#uid#")?.classList.add("blink#uid#")
            }
          } else {
            document.getElementById("battery-mppt-rect-#uid#")?.setAttribute("stroke", "var(--battery_mppt_colour#uid#)")
            document.getElementById("battery-mppt-power-#uid#")?.setAttribute("fill", "var(--battery_mppt_colour#uid#)")
            if (config#uid#.blink) {
              document.getElementById("battery-mppt-rect-#uid#")?.classList.remove("blink#uid#")
              document.getElementById("battery-mppt-rect-gauge-#uid#")?.classList.remove("blink#uid#")
              //if (config#uid#.font_alert) document.getElementById("battery-mppt-power-#uid#")?.classList.remove("blink#uid#")
            }
          }
          ///  SPEED  \\\
          log#uid#('| animation_speed = ' + config#uid#.battery.animation_speed)
          log#uid#('| max_power = ' + config#uid#.battery.max_power)
          let speed = config#uid#.battery.animation_speed - ((config#uid#.battery.animation_speed - 1.5) * Math.abs(totalFromInverter) / (config#uid#.battery.max_power || Math.abs(totalFromInverter)))
          speed = (speed >= 1.5) ? speed : 1.5
          log#uid#('| animation_speed = ' + speed)
          document.getElementById("battery-anim-charge-#uid#")?.setAttribute("dur",speed)
          document.getElementById("battery-anim-discharge-#uid#")?.setAttribute("dur",speed)
          
          if (config#uid#.has_load && el != 'init' && config#uid#.activateGaugeRatio) calculateGaugeRatio#uid#('calculateBattery')
        }
        ///  Battery capacity  \\\
        log#uid#('| ----------- battery_capacity & time --------------')
        let battery_capacity = 0
        log#uid#('| config#uid#.battery.state.state = ' + config#uid#.battery.state.state)
        
        //calculate remaining battery time to charge or discharge
        let totalSeconds = 0
        let formattedResultTime = ""
        let duration = ""
        if (config#uid#.battery.capacity !== false && config#uid#.battery.capacity > 0) {
          if (config#uid#.battery.power.state == 0) {
            log#uid#('| power.state == 0')
            totalSeconds = (((parseInt(config#uid#.battery.state.state) - config#uid#.battery.soc.shutdown) / 100) * config#uid#.battery.capacity) / 1 * 60 * 60
          } else if (config#uid#.battery.power.state > 0) { // Décharge
            log#uid#('| power.state > 0')
            totalSeconds = (((config#uid#.battery.state.state - config#uid#.battery.soc.shutdown) / 100) * config#uid#.battery.capacity) / config#uid#.battery.power.state * 60 * 60
            log#uid#('| energie restante = ' + ((config#uid#.battery.state.state - config#uid#.battery.soc.shutdown) / 100) * config#uid#.battery.capacity)
          } else if (config#uid#.battery.power.state < 0) { // Charge
            log#uid#('| power.state < 0')
            totalSeconds = ((((config#uid#.battery.full_capacity - config#uid#.battery.state.state) / 100) * config#uid#.battery.capacity) / config#uid#.battery.power.state) * 60 * 60 * -1
            log#uid#('| energie restante = ' + ((config#uid#.battery.full_capacity - config#uid#.battery.state.state) / 100) * config#uid#.battery.capacity)
          }
          log#uid#('| totalSeconds = ' + totalSeconds)
          const currentTime = new Date() // Create a new Date object representing the current time
          const durationMilliseconds = totalSeconds * 1000 // Convert the duration to milliseconds
          const resultTime = new Date(currentTime.getTime() + durationMilliseconds) // Add the duration in milliseconds
          const resultHours = resultTime.getHours() // Get the hours component of the resulting time
          const resultMinutes = resultTime.getMinutes() // Get the minutes component of the resulting time
          const formattedMinutes = resultMinutes.toString().padStart(2, "0")
          const formattedHours = resultHours.toString().padStart(2, "0")
          formattedResultTime = formattedHours + 'h' + formattedMinutes
          log#uid#('| formatted = ' + formattedResultTime)
          const days = Math.floor(totalSeconds / (60 * 60 * 24))
          const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60))
          const minutes = Math.floor((totalSeconds % (60 * 60)) / 60)
          if (days > 0) {
            duration += days
            duration += (hours <= 1) ? ' jour, ' : ' jours, '
          }
          if (hours > 0 || days > 0) {
            duration += hours
            duration += (hours <= 1) ? ' hr, ' : ' hrs, '
          }
          duration +=  minutes + ' min'
          log#uid#('| duration= ' + duration)
          if (config#uid#.battery.power.state == 0 || duration == '0 min') { // || config#uid#.battery.power.state == '0'
            document.getElementById("battery-duration-#uid#").innerHTML = ''
            document.getElementById("battery-duration-text-#uid#").innerHTML = ''
          } else {
            document.getElementById("battery-duration-#uid#").innerHTML = duration
            if (config#uid#.battery.power.state <= 0) document.getElementById("battery-duration-text-#uid#").innerHTML = 'CHARGE ' + config#uid#.battery.full_capacity + '% À ' + formattedResultTime
            if (config#uid#.battery.power.state >= 0) document.getElementById("battery-duration-text-#uid#").innerHTML = 'DÉCHARGE : ' + config#uid#.battery.soc.shutdown + '% À ' + formattedResultTime
          }
          if(timer_in#uid# === false) {
            log#uid#('| initialisation de la tempo')
            timer_in#uid# = setInterval(calculateBattery#uid#, 60000, 'timer_in')
          } else {
            log#uid#('| delete de la tempo & reinitialisation')
            clearInterval(timer_in#uid#)
            timer_in#uid# === false
            timer_in#uid# = setInterval(calculateBattery#uid#, 60000, 'timer_in')
          }
        }
      } // ElDomExist
      log#uid#('└──────────────────────────────────────────────────────')
    }
    
    function calculateGrid#uid#(el='') {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [calculateGrid()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#");
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {
        
        ///  COLORS  \\\
        let color = 'var(--grid_colour#uid#)'
        if (config#uid#.grid.power > 0) color = 'var(--grid-buy-colour#uid#)'
        else if (config#uid#.grid.power < 0) color = 'var(--grid-sell-colour#uid#)'
        document.getElementById("grid-line-1-#uid#")?.setAttribute("stroke", color)
        document.getElementById("grid-line-2-#uid#")?.setAttribute("stroke", color)
        
        ///  GAUGE  \\\
        if (config#uid#.grid.max_power && config#uid#.activateGauge) {
          let gaugePourcent = Math.abs(config#uid#.grid.power) * 100 / Math.abs(config#uid#.grid.max_power)
          let width_rect_gauge = Math.max(Math.min((gaugePourcent / 100 * 70), 70), 0)
          if (is_object(gauge = document.getElementById("grid-rect-gauge-#uid#"))) {
            gauge.setAttribute('width', width_rect_gauge)
            gauge.setAttribute("fill", color)
            if (config#uid#.grid.power < 0) {
              gauge.style.transform = "translateX(" + (70 - width_rect_gauge) + "px)"
            } else {
              gauge.style.transform = "translateX(0px)"
            }
          }
        }
        
        ///  ALERT  \\\
        if (config#uid#.grid.alert_power && Math.abs(config#uid#.grid.power) >= Math.abs(config#uid#.grid.alert_power)) {
          if (config#uid#.blink) {
            document.getElementById("grid-rect-#uid#")?.classList.add("blink#uid#")
            document.getElementById("grid-rect-gauge-#uid#")?.classList.add("blink#uid#")
            //if (config#uid#.font_alert) document.getElementById("grid-power-#uid#")?.classList.add("blink#uid#")
          }
          if (config#uid#.font_alert) document.getElementById("grid_power#uid#")?.setAttribute("fill", "var(--color_alerte#uid#)")
          document.getElementById("grid-rect-#uid#")?.setAttribute("stroke", "var(--color_alerte#uid#)")
        } else {
          if (config#uid#.blink) {
            document.getElementById("grid-rect-#uid#")?.classList.remove("blink#uid#")
            document.getElementById("grid-rect-gauge-#uid#")?.classList.remove("blink#uid#")
            //if (config#uid#.font_alert) document.getElementById("grid-power-#uid#")?.classList.remove("blink#uid#")
          }
          document.getElementById("grid-power-#uid#")?.setAttribute("fill", color)
          document.getElementById("grid-rect-#uid#")?.setAttribute("stroke", color)
        }
        
        ///  DOT  \\\
        let PowerTrunc = trunc#uid#(config#uid#.grid.power, config#uid#.powerTrunc)
        if(PowerTrunc > 0) {
          document.getElementById("grid-dot-buy-1-#uid#")?.setAttribute("fill", "var(--grid-buy-colour#uid#)");
          document.getElementById("grid-dot-buy-2-#uid#")?.setAttribute("fill", "var(--grid-buy-colour#uid#)");
          document.getElementById("grid-dot-sell-1-#uid#")?.setAttribute("fill", "transparent");
          document.getElementById("grid-dot-sell-2-#uid#")?.setAttribute("fill", "transparent");
        } else if (PowerTrunc < 0) {
          document.getElementById("grid-dot-buy-1-#uid#")?.setAttribute("fill", "transparent");
          document.getElementById("grid-dot-buy-2-#uid#")?.setAttribute("fill", "transparent");
          document.getElementById("grid-dot-sell-1-#uid#")?.setAttribute("fill", "var(--grid-sell-colour#uid#)");
          document.getElementById("grid-dot-sell-2-#uid#")?.setAttribute("fill", "var(--grid-sell-colour#uid#)");
        } else {
          document.getElementById("grid-dot-buy-1-#uid#")?.setAttribute("fill", "transparent");
          document.getElementById("grid-dot-buy-2-#uid#")?.setAttribute("fill", "transparent");
          document.getElementById("grid-dot-sell-1-#uid#")?.setAttribute("fill", "transparent");
          document.getElementById("grid-dot-sell-2-#uid#")?.setAttribute("fill", "transparent");
        }
        
        ///  SPEED  \\\
        log#uid#('| animation_speed = ' + config#uid#.grid.animation_speed)
        log#uid#('| max_power = ' + config#uid#.grid.max_power)
        log#uid#('| power = ' + config#uid#.grid.power)        
        let speed = config#uid#.grid.animation_speed - ((config#uid#.grid.animation_speed - 1.5) * Math.abs(config#uid#.grid.power) / (config#uid#.grid.max_power || Math.abs(config#uid#.grid.power)))
        speed = (speed >= 1.5) ? speed : 1.5
        document.getElementById("anim_grid_buy#uid#")?.setAttribute("dur",speed)
        document.getElementById("anim_grid_sell#uid#")?.setAttribute("dur",speed)
        document.getElementById("anim_grid_buy1#uid#")?.setAttribute("dur",speed)
        document.getElementById("anim_grid_sell1#uid#")?.setAttribute("dur",speed)
        log#uid#('| animation_speed = ' + speed)
        
        /// ICON  \\\
        if (config#uid#.grid.status === 1) {
          document.getElementById("grid-transmission-on-#uid#").style.color = color
          document.getElementById("grid-transmission-off-#uid#").style.color = color
          if (config#uid#.grid.power == 0) {
            document.getElementById("grid-transmission-off-#uid#")?.classList.remove("hidden-#uid#")
            document.getElementById("grid-transmission-on-#uid#")?.classList.add("hidden-#uid#")
          } else {
            document.getElementById("grid-transmission-on-#uid#")?.classList.remove("hidden-#uid#")
            document.getElementById("grid-transmission-off-#uid#")?.classList.add("hidden-#uid#")
          }
        }
      } // ElDomExist
      log#uid#('└──────────────────────────────────────────────────────')
      if (config#uid#.has_load && config#uid#.activateGaugeRatio) calculateGaugeRatio#uid#('calculateGrid')
    }
    
    function calculateGaugeRatio#uid#(el='') {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [calculateGaugeRatio()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#");
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {
        let RadiusCircle#uid# = 35
        let CIRCLE_CIRCUMFERENCE#uid# = 2 * Math.PI * RadiusCircle#uid#
        
        
        //let loadFromSolar = Math.max((config#uid#.solar.power - Math.abs(Math.min(config#uid#.battery.power.state, 0)) - Math.abs(Math.min(config#uid#.grid.power, 0))), 0)
        let loadFromSolar = Math.max((config#uid#.solar.power - Math.abs(Math.min(config#uid#.battery.power.state, 0)) + Math.abs(config#uid#.battery.mppt.power.state) - Math.abs(Math.min(config#uid#.grid.power, 0))), 0)
        
        let loadFromBattery = Math.max(config#uid#.battery.power.state, 0)
        let loadFromAux = config#uid#.aux.power
        let loadFromGridTemp = Math.max((config#uid#.load.power - loadFromSolar - loadFromBattery - loadFromAux), 0)
        let loadFromGrid = Math.min(loadFromGridTemp, Math.max(config#uid#.grid.power, 0))
        let loadFromUnknown = Math.max((config#uid#.load.power - loadFromSolar - loadFromBattery - loadFromAux - loadFromGrid), 0)
        
        let RECT_CIRCUMFERENCE#uid# = 2 * 64 + 2 * 30
        let homeBatteryCircumferenceRect = RECT_CIRCUMFERENCE#uid# * loadFromBattery / config#uid#.load.power
        let homeSolarCircumferenceRect = RECT_CIRCUMFERENCE#uid# * loadFromSolar / config#uid#.load.power
        let homeAuxCircumferenceRect = RECT_CIRCUMFERENCE#uid# * loadFromAux / config#uid#.load.power
        let homeGridCircumferenceRect = RECT_CIRCUMFERENCE#uid# * loadFromGrid / config#uid#.load.power
        let homeUnknownCircumferenceRect = RECT_CIRCUMFERENCE#uid# * loadFromUnknown / config#uid#.load.power

        document.getElementById("rate-solar-#uid#")?.setAttribute("stroke-dasharray", homeSolarCircumferenceRect + ' ' + (RECT_CIRCUMFERENCE#uid# - homeSolarCircumferenceRect))
        document.getElementById("rate-solar-#uid#")?.setAttribute("stroke-dashoffset", -(CIRCLE_CIRCUMFERENCE#uid# - homeSolarCircumferenceRect))
        document.getElementById("rate-battery-#uid#")?.setAttribute("stroke-dasharray", homeBatteryCircumferenceRect + ' ' + (RECT_CIRCUMFERENCE#uid# - homeBatteryCircumferenceRect))
        document.getElementById("rate-battery-#uid#")?.setAttribute("stroke-dashoffset", -(CIRCLE_CIRCUMFERENCE#uid# - homeSolarCircumferenceRect - homeBatteryCircumferenceRect))
        document.getElementById("rate-aux-#uid#")?.setAttribute("stroke-dasharray", homeAuxCircumferenceRect + ' ' + (RECT_CIRCUMFERENCE#uid# - homeAuxCircumferenceRect))
        document.getElementById("rate-aux-#uid#")?.setAttribute("stroke-dashoffset", -(CIRCLE_CIRCUMFERENCE#uid# - homeSolarCircumferenceRect - homeBatteryCircumferenceRect - homeAuxCircumferenceRect))
        document.getElementById("rate-grid-#uid#")?.setAttribute("stroke-dasharray", homeGridCircumferenceRect + ' ' + (RECT_CIRCUMFERENCE#uid# - homeGridCircumferenceRect))
        document.getElementById("rate-grid-#uid#")?.setAttribute("stroke-dashoffset", -(CIRCLE_CIRCUMFERENCE#uid# - homeSolarCircumferenceRect - homeBatteryCircumferenceRect - homeAuxCircumferenceRect - homeGridCircumferenceRect))
        document.getElementById("rate-unknown-#uid#")?.setAttribute("stroke-dasharray", homeUnknownCircumferenceRect + ' ' + (RECT_CIRCUMFERENCE#uid# - homeUnknownCircumferenceRect))
        document.getElementById("rate-unknown-#uid#")?.setAttribute("stroke-dashoffset", -(CIRCLE_CIRCUMFERENCE#uid# - homeSolarCircumferenceRect - homeBatteryCircumferenceRect - homeAuxCircumferenceRect - homeGridCircumferenceRect - homeUnknownCircumferenceRect))
      } // ElDomExist
      log#uid#('└──────────────────────────────────────────────────────')
    }
    /*
    function calculateGreenValue#uid#(el='') {
      
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [calculateGreenValue()] ───────────────')
      var ElDomExist = !!document.getElementById("widget#uid#");
      log#uid#('| ElDomExist ? ' + ElDomExist)
      if (ElDomExist) {
        log#uid#('config#uid#.solar.mppts (' + config#uid#.solar.mppts + ')')
        log#uid#('config#uid#.load.additional_loads (' + config#uid#.load.additional_loads + ')')
        log#uid#('config#uid#.grid.power (' + config#uid#.grid.power + ')')
        log#uid#('config#uid#.battery.power.state (' + config#uid#.battery.power.state + ')')
        log#uid#('config#uid#.solar.power (' + config#uid#.solar.power + ')')
        if(config#uid#.solar.mppts > 0 && config#uid#.load.additional_loads > 0) {
          //log#uid#((config#uid#.load.power - config#uid#.grid.power) * 100 / config#uid#.load.power)
        }
        
        
        if (config#uid#.solar.mppts > 0) {
          let solarConsumption = 0;
          solarConsumption = config#uid#.solar.power - ((config#uid#.grid.power <= 0) ? Math.abs(config#uid#.grid.power) : 0) - ((config#uid#.battery.power.state <= 0)  ? Math.abs(config#uid#.battery.power.state) : 0);
          log#uid#('| | solarConsumption = ' + solarConsumption)
          
          let batteryFromGrid = 0;
          let batteryToGrid = 0;
          if (solarConsumption < 0) {
            // What we returned to the grid and what went in to the battery is more
            // than produced, so we have used grid energy to fill the battery or
            // returned battery energy to the grid
            if (config#uid#.battery.power.show) {
              log#uid#('| | config#uid#.battery.power.show : ' + config#uid#.battery.power.show)
              batteryFromGrid = Math.abs(solarConsumption); //200
              log#uid#('| | batteryFromGrid : ' + batteryFromGrid)
              log#uid#('| | config#uid#.grid.power : ' + ((config#uid#.grid.power <= 0) ? 0 : Math.abs(config#uid#.grid.power)))
              if (batteryFromGrid > ((config#uid#.grid.power <= 0) ? 0 : Math.abs(config#uid#.grid.power))) { // totalFromGridNoUnit#uid#
                log#uid#('| | batteryFromGrid > config#uid#.grid.power')
                batteryToGrid = (config#uid#.grid.power <= 0) ? Math.min((batteryFromGrid - ((config#uid#.grid.power <= 0) ? 0 : Math.abs(config#uid#.grid.power))), batteryFromGrid) : 0;
                //batteryToGrid = Math.min((batteryFromGrid - ((config#uid#.grid.power <= 0) ? 0 : Math.abs(config#uid#.grid.power))), batteryFromGrid);
                batteryFromGrid = ((config#uid#.grid.power <= 0) ? 0 : Math.abs(config#uid#.grid.power));
              } else {
                batteryToGrid = 0 // add
                //batteryFromGrid = ((config#uid#.grid.power <= 0) ? 0 : Math.abs(config#uid#.grid.power));; // add
                //batteryToGrid = batteryFromGrid // add
                //batteryFromGrid = 0; // add
              } 
            }
            solarConsumption = 0;
            log#uid#('| | NEW solarConsumption : ' + solarConsumption)
            
          }
          log#uid#('| | batteryFromGrid : ' + batteryFromGrid)
          log#uid#('| | batteryToGrid : ' + batteryToGrid)
          
          let gridConsumption = Math.max(((config#uid#.grid.power >= 0) ? config#uid#.grid.power : 0) - batteryFromGrid, 0);
          log#uid#('| | gridConsumption : ' + gridConsumption)
          
          let batteryConsumption = 0;
          if (config#uid#.battery.power.show) {
            batteryConsumption = ((config#uid#.battery.power.state >= 0) ? config#uid#.battery.power.state : 0) - batteryToGrid
            log#uid#('| | batteryConsumption : ' + batteryConsumption)
          }
          
          let totalHomeConsumption = Math.max((gridConsumption + solarConsumption + batteryConsumption), 0);
          log#uid#('| | totalHomeConsumption : ' + totalHomeConsumption)
          
          var greenValue#uid# = 0
          greenValue#uid# = (totalHomeConsumption - ((config#uid#.grid.power >= 0) ? config#uid#.grid.power : 0)) * 100 / totalHomeConsumption
          if(isNaN(greenValue#uid#) == true) greenValue#uid# = 0
          log#uid#('| | greenValue : ' + greenValue#uid#)
          
        }
      }
      
    }
    */
    /* lancer par addUpdateFunction et toute les minutes 
    function getTime#uid# () {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [getTime()] ───────────────')
      if (is_object(cmd = document.querySelector('.cmd[data-cmd_uid="#uid#"]'))) {
        let reinitTempo = false
        let dToday = new Date()
        //dToday.setHours(22)
        let dTodayText = dToday.toLocaleString(navigator.language,{dateStyle: "full"})
        let hours = dToday.getHours()
        let dnext = new Date(dToday.getTime() + 86400000);
        let dnextText = dnext.toLocaleString(navigator.language,{dateStyle: "full"})
        if (is_object(document.getElementById("grid-tempo-today-text-#uid#"))) {
          if (Object.keys(JsonTempoArray#uid#).length > 0 && Array.isArray(JsonTempoArray#uid#)) { // si c'est un json valide qui est envoyé dans addUpdateFunction
            log#uid#(JsonTempoArray#uid#)
            log#uid#('|┌─────────────────── jsonTempo detecté ───────────────────')
            log#uid#('|| hours : ' + hours)
            if(JsonTempoArray#uid#[dTodayText]) {
              log#uid#('|| Date now ' + dTodayText + ' => ' + JsonTempoArray#uid#[dTodayText])
              document.getElementById("grid-tempo-today-circle-#uid#")?.setAttribute("fill", 'var(--' + getLabel(JsonTempoArray#uid#[dTodayText]) + ')')
              document.getElementById("grid-tempo-today-text-#uid#")?.setAttribute("fill", "var(--grid_colour#uid#)")
              document.getElementById("grid-tempo-today-text-#uid#").innerHTML = (hours >= 6 && hours < 22) ? 'HP' : 'HC'
            }
            else {
              document.getElementById("grid-tempo-today-circle-#uid#")?.setAttribute("fill", "transparent")
              document.getElementById("grid-tempo-today-text-#uid#")?.setAttribute("fill", "transparent")
            }
            if(JsonTempoArray#uid#[dnextText]) {
              log#uid#('|| Date tomorrow ' + dnextText + ' => ' + JsonTempoArray#uid#[dnextText])
              document.getElementById("grid-tempo-tomorrow-circle-#uid#")?.setAttribute("fill", 'var(--' + getLabel(JsonTempoArray#uid#[dnextText]) + ')')
              document.getElementById("grid-tempo-tomorrow-text-#uid#")?.setAttribute("fill", "var(--grid_colour#uid#)")
            }
            else {
              document.getElementById("grid-tempo-tomorrow-circle-#uid#")?.setAttribute("fill", "transparent")
              document.getElementById("grid-tempo-tomorrow-text-#uid#")?.setAttribute("fill", "transparent")
            }
            reinitTempo = true
            log#uid#('|└────────────────────────────────────')
          } else {
            document.getElementById("grid-tempo-tomorrow-circle-#uid#")?.setAttribute("fill", "transparent")
            document.getElementById("grid-tempo-tomorrow-text-#uid#")?.setAttribute("fill", "transparent")
            if (JsonTempoArray#uid#.includes('red') || JsonTempoArray#uid#.includes('rouge')){
              document.getElementById("grid-tempo-today-circle-#uid#")?.setAttribute("fill", 'var(--' + getLabel('RED') + ')')
              document.getElementById("grid-tempo-today-text-#uid#")?.setAttribute("fill", "var(--grid_colour#uid#)")
              document.getElementById("grid-tempo-today-text-#uid#").innerHTML = (hours >= 6 && hours < 22) ? 'HP' : 'HC'
              reinitTempo = true
            } else if (JsonTempoArray#uid#.includes('blue') || JsonTempoArray#uid#.includes('bleu')) {
              document.getElementById("grid-tempo-today-circle-#uid#")?.setAttribute("fill", 'var(--' + getLabel('BLUE') + ')')
              document.getElementById("grid-tempo-today-text-#uid#")?.setAttribute("fill", "var(--grid_colour#uid#)")
              document.getElementById("grid-tempo-today-text-#uid#").innerHTML = (hours >= 6 && hours < 22) ? 'HP' : 'HC'
              reinitTempo = true
            } else if (JsonTempoArray#uid#.includes('white') || JsonTempoArray#uid#.includes('blanc')) {
              document.getElementById("grid-tempo-today-circle-#uid#")?.setAttribute("fill", 'var(--' + getLabel('WHITE') + ')')
              document.getElementById("grid-tempo-today-text-#uid#")?.setAttribute("fill", "var(--grid_colour#uid#)")
              document.getElementById("grid-tempo-today-text-#uid#").innerHTML = (hours >= 6 && hours < 22) ? 'HP' : 'HC'
              reinitTempo = true
            } else {
              document.getElementById("grid-tempo-today-circle-#uid#")?.setAttribute("fill", "transparent")
              document.getElementById("grid-tempo-today-text-#uid#")?.setAttribute("fill", "transparent")
            }
          }
        
          if(timer#uid# === false) {
            if (reinitTempo) { 
              log#uid#('| initialisation de la tempo')
              timer#uid# = setInterval(getTime#uid#, 30000, 'timer')
            }
          } else {
            log#uid#('| delete de la tempo')
            clearInterval(timer#uid#)
            timer#uid# === false
            if (reinitTempo) {
              log#uid#('| reinitialisation de la tempo')
              timer#uid# = setInterval(getTime#uid#, 30000, 'timer')
            }
          }
        }
        log#uid#('└────────────────────────────────────')
      }
    }
    */
      
    /*
    jeedom.cmd.addUpdateFunction('#uid#', function(_options) {
      log#uid#('┌─────────────────── Widget Distribution Onduleur [#uid#] en debug [addUpdateFunction()] ───────────────')
      clearTimeout(timer#uid#);
      let IS_JSON = true;
      JsonTempoArray#uid# = []
      let tempoJour = ''
      let dToday = new Date()
      let hours = dToday.getHours()
      if (is_object(cmd = document.querySelector('.cmd[data-cmd_uid="#uid#"]'))) {
        try { var obj = JSON.parse(_options.display_value) }
        catch(err) { IS_JSON = false }
        if (_options.display_value != "" && IS_JSON && isNaN(_options.display_value)) {
          log#uid#('| -> jsonTempo detecté')
          let dToday = new Date()
          let hours = dToday.getHours()
          for(key in obj){
            let dateTemp = new Date(obj[key]['datetime'])
            JsonTempoArray#uid#[(dateTemp.toLocaleString(navigator.language,{dateStyle: "full"}))] = (obj[key]['value'])?obj[key]['value']:'undefined'
          }
          getTime#uid#()
        }
        else {
          log#uid#('| -> no jsonTempo detecté')
          let value = _options.display_value.toLowerCase()
          document.getElementById("grid-tempo-tomorrow-circle-#uid#")?.setAttribute("fill", "transparent")
          document.getElementById("grid-tempo-tomorrow-text-#uid#")?.setAttribute("fill", "transparent")
          if (value.includes('red') || value.includes('rouge')) JsonTempoArray#uid# = 'red'
          else if (value.includes('blue') || value.includes('bleu')) JsonTempoArray#uid# = 'blue'
          else if (value.includes('white') || value.includes('blanc')) JsonTempoArray#uid# = 'white'
          getTime#uid#()
        }
      }
      log#uid#('└────────────────────────────────────')
    })
    */
    jeedom.cmd.refreshValue([{ cmd_id: '#uid#', value: '#value#', display_value: '#state#', valueDate: '#valueDate#', collectDate: '#collectDate#', alertLevel: '#alertLevel#', unit: '#unite#' }])
    
  </script>
  </div>
  </div>
</div>